        <div id="help-modal" class="modal"><div class="modal-content"><h3>éŠæˆ²èªªæ˜</h3><h4>1. AIé©…å‹•çš„ç”Ÿæ…‹æ¨¡æ“¬</h4><p><b style="color: #10b981;">çœŸå¯¦AIç”Ÿæˆå…§å®¹ï¼š</b>æ­¤éŠæˆ²ä½¿ç”¨ Gemini AI å³æ™‚ç”Ÿæˆå¤šå…ƒåŒ–çš„ç”Ÿæ…‹äº‹ä»¶å’Œå›æ‡‰ï¼Œæ¯æ¬¡éŠæˆ²é«”é©—éƒ½ç¨ä¸€ç„¡äºŒã€‚<br><br><b>é–‹å§‹éŠæˆ²å‰è«‹ï¼š</b><br>1. å–å¾—å…è²»çš„ Gemini API Keyï¼š<a href="https://lifecheatslab.com/freegeminiapi/" target="_blank" rel="noopener noreferrer">ç”³è«‹æ•™å­¸</a><br>2. åœ¨è¨­å®šå€å¡Šä¸­è¼¸å…¥ä¸¦ä¿å­˜æ‚¨çš„ API Key<br>3. å¦‚é‡ç¶²è·¯é™åˆ¶ï¼Œè«‹å°‡ä»£ç¢¼è¤‡è£½åˆ°æ‚¨è‡ªå·±çš„ç’°å¢ƒ</p><h4>2. éŠæˆ²ç©æ³•</h4><ul><li>æ‚¨æ‰®æ¼”ä¸€ä½ç”Ÿæ…‹å­¸å®¶ï¼Œè² è²¬æ‹¯æ•‘ç€•å±çš„ç”Ÿæ…‹ç³»çµ±ã€‚</li><li>AIæœƒæ ¹æ“šç•¶å‰ç‹€æ³ç”ŸæˆçœŸå¯¦çš„ç”Ÿæ…‹äº‹ä»¶ï¼Œæ¯å€‹äº‹ä»¶éƒ½è€ƒæ…®äº†ç”Ÿæ…‹å­¸åŸç†ã€‚</li><li>æ‚¨å¯ä»¥é»æ“Šã€Œå¯¦æ–½ã€æˆ–ã€Œæ‹’çµ•ã€å¿«é€Ÿæ±ºç­–ï¼Œæˆ–è¼¸å…¥è©³ç´°çš„ä¿è‚²ç­–ç•¥ã€‚</li><li>AIæœƒåˆ†ææ‚¨çš„æ±ºç­–ï¼Œæ ¹æ“šç”Ÿæ…‹ç³»çµ±ç›¸äº’ä¾å­˜é—œä¿‚èª¿æ•´å››å¤§æŒ‡æ¨™ã€‚</li><li>äº‹ä»¶æœƒéš¨æ™‚é–“æ¼”è®Šï¼šæ—©æœŸæ˜¯é é˜²æ€§å•é¡Œï¼Œå¾ŒæœŸæ˜¯ç·Šæ€¥å±æ©Ÿã€‚</li></ul><h4>3. å››å¤§ç”Ÿæ…‹æŒ‡æ¨™</h4><ul><li><b>ğŸŒ± ç”Ÿç”¢è€…</b>ï¼šæ¤ç‰©ã€è—»é¡ç­‰è‡ªç‡Ÿç”Ÿç‰©</li><li><b>ğŸ¦‹ åˆç´šæ¶ˆè²»è€…</b>ï¼šè‰é£Ÿå‹•ç‰©ã€æµ®æ¸¸å‹•ç‰©ç­‰</li><li><b>ğŸº æ¬¡ç´šæ¶ˆè²»è€…</b>ï¼šè‚‰é£Ÿå‹•ç‰©ã€é ‚ç´šæ é£Ÿè€…</li><li><b><!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿæ…‹å®ˆè­·è€… - æ‹¯æ•‘ç€•å±ç”Ÿæ…‹ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #1e3a8a 0%, #059669 50%, #065f46 100%); color: #e2e8f0; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .game-container { width: 100%; max-width: 900px; background-color: rgba(45, 55, 72, 0.95); border-radius: 20px; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5); padding: 20px; display: flex; flex-direction: column; gap: 15px; backdrop-filter: blur(10px); }
        .stat-bar { height: 12px; background-color: #4a5568; border-radius: 6px; overflow: hidden; }
        .stat-fill { height: 100%; transition: width 0.5s ease-in-out; }
        .stat-fill.critical { background-color: #dc2626; }
        .stat-fill.warning { background-color: #f59e0b; }
        .stat-fill.good { background-color: #10b981; }
        .stat-fill.excellent { background-color: #059669; }
        button { padding: 10px 20px; border-radius: 10px; font-weight: bold; cursor: pointer; transition: all 0.2s ease-in-out; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2); font-size: 0.95rem; }
        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3); }
        button:disabled { cursor: not-allowed; opacity: 0.6; }
        .btn-primary { background-color: #10b981; color: white; border: none; }
        .btn-primary:hover:not(:disabled) { background-color: #059669; }
        .btn-secondary { background-color: #6b7280; color: white; border: none; }
        .btn-secondary:hover:not(:disabled) { background-color: #4b5563; }
        .btn-danger { background-color: #dc2626; color: white; border: none; }
        .btn-danger:hover:not(:disabled) { background-color: #b91c1c; }
        input[type="text"], input[type="password"], textarea, select { background-color: #4a5568; color: #e2e8f0; border: 1px solid #10b981; border-radius: 10px; padding: 10px 12px; width: 100%; box-sizing: border-box; outline: none; }
        input[type="file"] { display: none; }
        .file-upload-label { background-color: #6b7280; color: white; padding: 8px 12px; border-radius: 8px; cursor: pointer; text-align: center; display: block; }
        .file-upload-label:hover { background-color: #4b5563; }
        input:focus, textarea:focus, select:focus { border-color: #059669; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3); }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 999; display: none; justify-content: center; align-items: center; padding: 20px; }
        .modal-content { background-color: #2d3748; padding: 25px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.7); max-width: 600px; width: 100%; border: 2px solid #10b981; max-height: 90vh; overflow-y: auto; }
        .modal-content h3 { font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; color: #10b981;}
        .modal-content h4 { font-size: 1.2rem; font-weight: bold; margin-top: 1.5rem; margin-bottom: 0.5rem; color: #34d399; border-bottom: 1px solid #4a5568; padding-bottom: 0.25rem;}
        .modal-content p, .modal-content li { color: #e2e8f0; line-height: 1.6; }
        .modal-content ul { list-style-type: disc; padding-left: 20px; }
        .modal-content a { color: #10b981; text-decoration: underline; }
        .modal-content button { margin-top: 20px; }
        .collapsible-header { background-color: #374151; color: white; padding: 12px 20px; border-radius: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; transition: background-color 0.2s ease-in-out; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); }
        .collapsible-header.expanded-header { border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
        .collapsible-header:hover { background-color: #10b981; }
        .collapsible-content { padding: 0 15px; background-color: #2d3748; border-radius: 0 0 10px 10px; border: 1px solid #4a5568; border-top: none; overflow: hidden; max-height: 0; transition: max-height 0.3s ease-out, padding 0.3s ease-out, opacity 0.3s ease-out; opacity: 0; pointer-events: none; }
        .collapsible-content.expanded { max-height: 500px; padding: 15px; border-top: 1px solid #4a5568; opacity: 1; pointer-events: auto; }
        .collapsible-icon { transition: transform 0.3s ease-in-out; }
        .collapsible-icon.rotated { transform: rotate(90deg); }
        #advisor-portrait-img { width: 150px; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); }
        .event-description-text { font-size: 1.1rem; line-height: 1.6; color: #e2e8f0; white-space: pre-wrap; flex-grow: 1; overflow-y: auto; padding-right: 5px; }
        #stat-changes-display { background-color: rgba(0,0,0,0.3); border-radius: 8px; padding: 8px 12px; margin-top: 15px; font-size: 0.9rem; text-align: left; line-height: 1.5; }
        #temp-message { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background-color: #374151; color: white; padding: 8px 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3); z-index: 1001; opacity: 0; transition: opacity 0.5s ease-out; pointer-events: none; }
        #temp-message.show { opacity: 1; }
        .ecosystem-visual { background: linear-gradient(to bottom, #0ea5e9 0%, #10b981 30%, #059669 70%, #064e3b 100%); border-radius: 15px; padding: 20px; margin: 10px 0; text-align: center; font-size: 2rem; min-height: 120px; display: flex; align-items: center; justify-content: center; }
        .time-indicator { background-color: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; text-align: center; font-weight: bold; }
    </style>
</head>
<body class="antialiased">
    <div id="message-modal" class="modal"><div class="modal-content"><h3 id="message-title"></h3><p id="message-content"></p><div class="flex justify-center gap-4"><button class="btn-primary" id="message-button">ç¢ºèª</button></div></div></div>
            <div id="help-modal" class="modal"><div class="modal-content"><h3>éŠæˆ²èªªæ˜</h3><h4>1. é—œæ–¼æ­¤æ¼”ç¤ºç‰ˆæœ¬</h4><p><b style="color: #10b981;">æ­¤ç‚ºæ¼”ç¤ºç‰ˆæœ¬ï¼š</b>ç”±æ–¼ Claude.ai ç’°å¢ƒé™åˆ¶ï¼Œç„¡æ³•èª¿ç”¨å¤–éƒ¨ APIã€‚éŠæˆ²ä½¿ç”¨é è¨­çš„æ¨¡æ“¬äº‹ä»¶å’Œå›æ‡‰ä¾†å±•ç¤ºç©æ³•ã€‚<br><br><b>å¦‚éœ€å®Œæ•´ AI äº’å‹•åŠŸèƒ½ï¼š</b><br>1. è¤‡è£½æ­¤ä»£ç¢¼åˆ°æ‚¨è‡ªå·±çš„ç¶²é ç’°å¢ƒ<br>2. å–å¾— Gemini API Keyï¼š<a href="https://lifecheatslab.com/freegeminiapi/" target="_blank" rel="noopener noreferrer">å…è²»ç”³è«‹æ•™å­¸</a><br>3. å•Ÿç”¨ç¶²è·¯è«‹æ±‚åŠŸèƒ½</p><h4>2. éŠæˆ²ç©æ³•</h4><ul><li>æ‚¨æ‰®æ¼”ä¸€ä½ç”Ÿæ…‹å­¸å®¶ï¼Œè² è²¬æ‹¯æ•‘ç€•å±çš„ç”Ÿæ…‹ç³»çµ±ã€‚</li><li>æ¯å€‹å›åˆéƒ½æœƒé¢è‡¨ä¸€ä»¶ç”Ÿæ…‹äº‹ä»¶ï¼Œæ‚¨éœ€è¦åšå‡ºæ±ºç­–ä¾†ç¶­æŒç”Ÿæ…‹å¹³è¡¡ã€‚</li><li>æ‚¨å¯ä»¥é»æ“Šã€Œå¯¦æ–½ã€æˆ–ã€Œæ‹’çµ•ã€å¿«é€Ÿæ±ºç­–ï¼Œæˆ–è¼¸å…¥è©³ç´°çš„ä¿è‚²ç­–ç•¥ã€‚</li><li>æ‚¨çš„æ¯å€‹æ±ºç­–éƒ½æœƒå½±éŸ¿ç”Ÿæ…‹ç³»çš„å››å¤§æŒ‡æ¨™ï¼šğŸŒ±ç”Ÿç”¢è€…ã€ğŸ¦‹åˆç´šæ¶ˆè²»è€…ã€ğŸºæ¬¡ç´šæ¶ˆè²»è€…ã€ğŸ„åˆ†è§£è€…ã€‚</li><li>è«‹è¬¹æ…ç¶­æŒå„é …æ•¸å€¼çš„å¹³è¡¡ã€‚ä»»ä½•ä¸€é …éä½éƒ½å¯èƒ½å°è‡´ç”Ÿæ…‹ç³»çµ±å´©æ½°ã€‚</li></ul><h4>3. ç”Ÿæ…‹ç³»çµ±é¡å‹</h4><ul><li><b>æ£®æ—ç”Ÿæ…‹ç³»</b>ï¼šè±å¯Œçš„æ¤è¢«å±¤æ¬¡èˆ‡ç”Ÿç‰©å¤šæ¨£æ€§</li><li><b>è‰åŸç”Ÿæ…‹ç³»</b>ï¼šä»¥è‰æœ¬æ¤ç‰©ç‚ºä¸»çš„é–‹é—Šç”Ÿæ…‹ç³»çµ±</li><li><b>æ·¡æ°´ç”Ÿæ…‹ç³»</b>ï¼šæ²³æµã€æ¹–æ³Šç­‰æ·¡æ°´ç’°å¢ƒ</li><li><b>æµ·æ´‹ç”Ÿæ…‹ç³»</b>ï¼šå»£é—Šçš„æµ·æ´‹ç’°å¢ƒ</li><li><b>æ¿•åœ°ç”Ÿæ…‹ç³»</b>ï¼šæ°´é™¸äº¤ç•Œçš„ç¨ç‰¹ç’°å¢ƒ</li><li><b>æ²™æ¼ ç”Ÿæ…‹ç³»</b>ï¼šä¹¾æ—±ç’°å¢ƒä¸‹çš„ç‰¹æ®Šç”Ÿæ…‹ç³»çµ±</li></ul><h4>4. å‹åˆ©æ¢ä»¶</h4><p>ç•¶æ‰€æœ‰ç”Ÿæ…‹æŒ‡æ¨™ç¶­æŒåœ¨å¥åº·æ°´æº–ï¼ˆ70ä»¥ä¸Šï¼‰è¶…é20å€‹æ™‚é–“å–®ä½æ™‚ï¼Œæ‚¨å°±æˆåŠŸæ‹¯æ•‘äº†ç”Ÿæ…‹ç³»çµ±ï¼</p><div class="text-center"><button class="btn-primary" id="close-help-btn">é–‹å§‹é«”é©—</button></div></div></div>
    <div id="temp-message"></div>

    <div class="game-container">
        <h1 class="text-3xl font-bold text-center mb-5">ğŸŒ ç”Ÿæ…‹å®ˆè­·è€… - æ‹¯æ•‘ç€•å±ç”Ÿæ…‹ç³»çµ±</h1>
        
        <div class="mb-5 bg-gray-700 rounded-lg shadow-md">
            <div class="collapsible-header" id="api-key-header"><span>ğŸ”‘ Gemini API Key è¨­å®š</span><svg class="collapsible-icon w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg></div>
            <div class="collapsible-content" id="api-key-content"><label for="gemini-api-key" class="block text-sm font-medium text-gray-300 mb-2">æ‚¨çš„Gemini API Key:</label><div class="flex flex-col sm:flex-row gap-3"><input type="text" id="gemini-api-key" placeholder="åœ¨æ­¤è¼¸å…¥æ‚¨çš„Gemini API Key" class="flex-grow"><button class="btn-primary" id="save-api-key-btn">ä¿å­˜API Key</button></div></div>
        </div>
        
        <div class="mb-5 bg-gray-700 rounded-lg shadow-md">
            <div class="collapsible-header" id="ai-persona-header"><span>ğŸ§¬ AIç”Ÿæ…‹é¡§å•å€‹æ€§è¨­å®š</span><svg class="collapsible-icon w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg></div>
            <div class="collapsible-content" id="ai-persona-content"><label for="ai-persona-prompt" class="block text-sm font-medium text-gray-300 mb-2">ç³»çµ±æè©:</label><textarea id="ai-persona-prompt" rows="4" class="w-full"></textarea><div class="flex flex-wrap gap-2 mt-3"><button id="preset-conservative" class="btn-secondary text-sm px-3 py-1">ä¿å®ˆæ´¾ç”Ÿæ…‹å­¸å®¶</button><button id="preset-activist" class="btn-secondary text-sm px-3 py-1">æ¿€é€²ç’°ä¿ä¸»ç¾©è€…</button><button id="preset-pragmatic" class="btn-secondary text-sm px-3 py-1">å¯¦ç”¨ä¸»ç¾©è€…</button><button class="btn-primary" id="update-persona-btn">æ›´æ–°å€‹æ€§è¨­å®š</button></div></div>
        </div>
        
        <div class="ecosystem-selector rounded-lg shadow-md mb-5">
            <label for="ecosystem-type" class="block text-sm font-medium text-gray-300 mb-2 text-center">ğŸŒ ç›®æ¨™ç”Ÿæ…‹ç³»çµ±:</label>
            <select id="ecosystem-type" class="w-full text-center"><option value="æ£®æ—ç”Ÿæ…‹ç³»" selected>ğŸŒ² æ£®æ—ç”Ÿæ…‹ç³»</option><option value="è‰åŸç”Ÿæ…‹ç³»">ğŸŒ¾ è‰åŸç”Ÿæ…‹ç³»</option><option value="æ·¡æ°´ç”Ÿæ…‹ç³»">ğŸï¸ æ·¡æ°´ç”Ÿæ…‹ç³»</option><option value="æµ·æ´‹ç”Ÿæ…‹ç³»">ğŸŒŠ æµ·æ´‹ç”Ÿæ…‹ç³»</option><option value="æ¿•åœ°ç”Ÿæ…‹ç³»">ğŸ¦† æ¿•åœ°ç”Ÿæ…‹ç³»</option><option value="æ²™æ¼ ç”Ÿæ…‹ç³»">ğŸœï¸ æ²™æ¼ ç”Ÿæ…‹ç³»</option></select>
        </div>

        <div class="ecosystem-visual" id="ecosystem-visual">
            <div id="ecosystem-emoji">ğŸŒ²ğŸ¦‹ğŸºğŸ„</div>
        </div>

        <div class="time-indicator mb-4">
            <div class="text-lg font-bold">ğŸ• æ™‚é–“è»¸: ç¬¬ <span id="time-count">0</span> å€‹æ™‚é–“å–®ä½</div>
            <div class="text-sm mt-2">ç”Ÿæ…‹ç³»çµ±ç‹€æ…‹: <span id="ecosystem-status" class="font-bold text-yellow-400">ç€•å±</span></div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-5">
            <div class="p-3 bg-gray-600 rounded-lg">
                <div class="flex justify-between text-sm font-medium mb-1"><span>ğŸŒ± ç”Ÿç”¢è€…</span><span id="producer-bar-value">30</span></div>
                <div class="stat-bar"><div id="producer-bar" class="stat-fill" style="width: 30%;"></div></div>
            </div>
            <div class="p-3 bg-gray-600 rounded-lg">
                <div class="flex justify-between text-sm font-medium mb-1"><span>ğŸ¦‹ åˆç´šæ¶ˆè²»è€…</span><span id="primary-bar-value">25</span></div>
                <div class="stat-bar"><div id="primary-bar" class="stat-fill" style="width: 25%;"></div></div>
            </div>
            <div class="p-3 bg-gray-600 rounded-lg">
                <div class="flex justify-between text-sm font-medium mb-1"><span>ğŸº æ¬¡ç´šæ¶ˆè²»è€…</span><span id="secondary-bar-value">20</span></div>
                <div class="stat-bar"><div id="secondary-bar" class="stat-fill" style="width: 20%;"></div></div>
            </div>
            <div class="p-3 bg-gray-600 rounded-lg">
                <div class="flex justify-between text-sm font-medium mb-1"><span>ğŸ„ åˆ†è§£è€…</span><span id="decomposer-bar-value">35</span></div>
                <div class="stat-bar"><div id="decomposer-bar" class="stat-fill" style="width: 35%;"></div></div>
            </div>
        </div>

        <div class="flex flex-col sm:flex-row gap-4 mb-5">
            <div class="w-full sm:w-1/3 bg-gray-600 rounded-lg p-3 flex flex-col items-center justify-start">
                <img id="advisor-portrait-img" src="https://i.ibb.co/TYpZx1z/eco-scientist.jpg" alt="ç”Ÿæ…‹é¡§å•">
                <div class="w-full mt-2 space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">é¸æ“‡é è¨­å½¢è±¡:</label>
                        <div class="flex justify-around gap-2">
                            <button id="set-scientist-portrait" class="btn-secondary text-sm flex-1">ç§‘å­¸å®¶</button>
                            <button id="set-activist-portrait" class="btn-secondary text-sm flex-1">æ´»å‹•å®¶</button>
                            <button id="set-researcher-portrait" class="btn-secondary text-sm flex-1">ç ”ç©¶å“¡</button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">è‡ªè¨‚å½¢è±¡ (å»ºè­°150x200px):</label>
                        <label for="upload-portrait-input" class="file-upload-label text-sm">ä¸Šå‚³æª”æ¡ˆ (.png, .jpg)</label>
                        <input type="file" id="upload-portrait-input" accept="image/png, image/jpeg">
                    </div>
                    <div class="collapsible-header" id="url-portrait-header">
                        <span>ä½¿ç”¨ç¶²å€è¨­å®š</span>
                        <svg class="collapsible-icon w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <div class="collapsible-content" id="url-portrait-content">
                        <input type="text" id="portrait-url-input" placeholder="è²¼ä¸Šåœ–ç‰‡ç¶²å€(URL)..." class="text-sm">
                        <button id="set-url-portrait-btn" class="btn-primary w-full mt-2 text-sm">è¨­å®šç¶²å€å½¢è±¡</button>
                    </div>
                </div>
            </div>
            
            <div class="w-full sm:w-2/3 bg-gray-700/50 rounded-lg p-4 flex flex-col">
                <div class="advisor-dialogue-area bg-gray-800/30 mb-4">
                    <p id="advisor-dialogue-text" class="advisor-dialogue-text">åšå£«ï¼Œè«‹é–‹å§‹æ–°çš„æ™‚é–“å‘¨æœŸä»¥æ¥æ”¶ç”Ÿæ…‹ç›£æ¸¬å ±å‘Šã€‚</p>
                </div>
                <div class="event-display-area bg-gray-800/30 flex-grow">
                    <h2 class="text-xl font-bold mb-3 flex items-center justify-center gap-3">
                        <span id="event-category-icon" class="text-2xl">ğŸŒ</span>
                        <span>ç”Ÿæ…‹äº‹ä»¶å ±å‘Š</span>
                    </h2>
                    <p id="event-description-text" class="event-description-text">è«‹é»æ“Šã€Œé–‹å§‹æ–°å‘¨æœŸã€ä¾†æ¥æ”¶æœ€æ–°çš„ç”Ÿæ…‹ç›£æ¸¬å ±å‘Šã€‚</p>
                    <div id="stat-changes-display" class="hidden w-full"></div>
                    <div id="loading-indicator" class="loading-indicator hidden">
                        <svg class="animate-spin h-5 w-5 text-green-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                </div>
                <button class="btn-primary mt-4" id="new-event-btn">é–‹å§‹æ–°å‘¨æœŸ</button>
            </div>
        </div>

        <div id="decision-area" class="input-area mb-5">
            <div class="flex gap-4 mb-3">
                <button id="yes-btn" class="btn-primary flex-1">å¯¦æ–½</button>
                <button id="no-btn" class="btn-danger flex-1">æ‹’çµ•</button>
            </div>
            <input type="text" id="player-input" placeholder="æˆ–åœ¨æ­¤è¼¸å…¥æ‚¨çš„è©³ç´°ä¿è‚²ç­–ç•¥..." class="mb-3">
            <button class="btn-primary w-full" id="submit-decision-btn">åŸ·è¡Œç­–ç•¥</button>
        </div>

        <div class="flex flex-wrap justify-center gap-4">
            <button class="btn-secondary" id="open-help-btn">éŠæˆ²èªªæ˜</button>
            <button class="btn-secondary" id="save-game-btn">ä¿å­˜é€²åº¦</button>
            <button class="btn-secondary" id="load-game-btn">è¼‰å…¥é€²åº¦</button>
            <button class="btn-secondary" id="new-game-btn">é‡æ–°é–‹å§‹</button>
        </div>
    </div>

    <script type="module">
        const ui = {
            timeCount: document.getElementById('time-count'),
            ecosystemStatus: document.getElementById('ecosystem-status'),
            producerValue: document.getElementById('producer-bar-value'),
            primaryValue: document.getElementById('primary-bar-value'), 
            secondaryValue: document.getElementById('secondary-bar-value'),
            decomposerValue: document.getElementById('decomposer-bar-value'),
            producerBar: document.getElementById('producer-bar'),
            primaryBar: document.getElementById('primary-bar'),
            secondaryBar: document.getElementById('secondary-bar'),
            decomposerBar: document.getElementById('decomposer-bar'),
            advisorDialogue: document.getElementById('advisor-dialogue-text'),
            eventDescription: document.getElementById('event-description-text'),
            playerInput: document.getElementById('player-input'),
            submitDecisionBtn: document.getElementById('submit-decision-btn'),
            newEventBtn: document.getElementById('new-event-btn'),
            yesBtn: document.getElementById('yes-btn'),
            noBtn: document.getElementById('no-btn'),
            loadingIndicator: document.getElementById('loading-indicator'),
            apiKeyInput: document.getElementById('gemini-api-key'),
            saveApiKeyBtn: document.getElementById('save-api-key-btn'),
            personaPrompt: document.getElementById('ai-persona-prompt'),
            updatePersonaBtn: document.getElementById('update-persona-btn'),
            advisorPortrait: document.getElementById('advisor-portrait-img'),
            setScientistPortraitBtn: document.getElementById('set-scientist-portrait'),
            setActivistPortraitBtn: document.getElementById('set-activist-portrait'),
            setResearcherPortraitBtn: document.getElementById('set-researcher-portrait'),
            uploadPortraitInput: document.getElementById('upload-portrait-input'),
            portraitUrlInput: document.getElementById('portrait-url-input'),
            setUrlPortraitBtn: document.getElementById('set-url-portrait-btn'),
            decisionArea: document.getElementById('decision-area'),
            ecosystemTypeSelect: document.getElementById('ecosystem-type'),
            saveGameBtn: document.getElementById('save-game-btn'),
            loadGameBtn: document.getElementById('load-game-btn'),
            newGameBtn: document.getElementById('new-game-btn'),
            messageModal: document.getElementById('message-modal'),
            messageTitle: document.getElementById('message-title'),
            messageContent: document.getElementById('message-content'),
            messageButton: document.getElementById('message-button'),
            helpModal: document.getElementById('help-modal'),
            openHelpBtn: document.getElementById('open-help-btn'),
            closeHelpBtn: document.getElementById('close-help-btn'),
            tempMessage: document.getElementById('temp-message'),
            presetConservative: document.getElementById('preset-conservative'),
            presetActivist: document.getElementById('preset-activist'),
            presetPragmatic: document.getElementById('preset-pragmatic'),
            statChangesDisplay: document.getElementById('stat-changes-display'),
            eventCategoryIcon: document.getElementById('event-category-icon'),
            ecosystemVisual: document.getElementById('ecosystem-visual'),
            ecosystemEmoji: document.getElementById('ecosystem-emoji'),
        };
        
        let gameState = {};
        let isInitialLoad = true;
        
        const STAT_MAX = 100, STAT_MIN = 0;
        const CRITICAL_THRESHOLD = 15;
        const RECOVERY_THRESHOLD = 70;
        const VICTORY_TIME = 20;
        
        const defaultPortraits = {
            scientist: 'https://i.ibb.co/TYpZx1z/eco-scientist.jpg',
            activist: 'https://i.ibb.co/ZGJxq1m/eco-activist.jpg', 
            researcher: 'https://i.ibb.co/rmvK8yh/eco-researcher.jpg'
        };
        
        const presetPersonas = {
            'conservative': "æ‚¨æ˜¯ä¸€ä½è¬¹æ…ä¿å®ˆçš„ç”Ÿæ…‹å­¸å®¶ï¼Œå¼·èª¿ç§‘å­¸è­‰æ“šå’Œé•·æœŸç ”ç©¶ï¼Œåå¥½å¾ªåºæ¼¸é€²çš„ä¿è‚²æ–¹æ³•ã€‚æ‚¨çš„å»ºè­°åŸºæ–¼åš´è¬¹çš„ç§‘å­¸åŸç†ï¼Œä¸æœƒå†’éšªæ¡ç”¨æœªç¶“è­‰å¯¦çš„æ–¹æ³•ã€‚å¦‚æœç©å®¶çš„æŒ‡ä»¤æ¶‰åŠèˆ‡æ‚¨çš„äº’å‹•ï¼Œè«‹ä»¥å°ˆæ¥­è€Œè¬¹æ…çš„ç”Ÿæ…‹å­¸å®¶èº«ä»½å›æ‡‰ã€‚",
            'activist': "æ‚¨æ˜¯ä¸€ä½æ¿€é€²çš„ç’°ä¿ä¸»ç¾©è€…ï¼Œæ·±ä¿¡éœ€è¦å¤§è†½è¡Œå‹•ä¾†æ‹¯æ•‘ç”Ÿæ…‹ç³»çµ±ã€‚æ‚¨é¡˜æ„æ¡ç”¨å‰µæ–°ä½†æœ‰é¢¨éšªçš„æ–¹æ³•ï¼Œèªç‚ºç·Šæ€¥æƒ…æ³éœ€è¦ç·Šæ€¥æ‰‹æ®µã€‚æ‚¨çš„å»ºè­°å……æ»¿ç†±æƒ…ä½†ä¹Ÿå……æ»¿æŒ‘æˆ°æ€§ã€‚å¦‚æœç©å®¶çš„æŒ‡ä»¤æ¶‰åŠèˆ‡æ‚¨çš„äº’å‹•ï¼Œè«‹ä»¥å……æ»¿ç†±å¿±çš„ç’°ä¿æ´»å‹•å®¶èº«ä»½å›æ‡‰ã€‚",
            'pragmatic': "æ‚¨æ˜¯ä¸€ä½å¯¦ç”¨ä¸»ç¾©çš„ç”Ÿæ…‹é¡§å•ï¼Œå¹³è¡¡ç§‘å­¸æ€§èˆ‡å¯¦ç”¨æ€§ï¼Œèƒ½å¤ åœ¨ç†æƒ³èˆ‡ç¾å¯¦ä¹‹é–“æ‰¾åˆ°å¯è¡Œçš„è§£æ±ºæ–¹æ¡ˆã€‚æ‚¨è€ƒæ…®è³‡æºé™åˆ¶å’Œå¯¦æ–½å¯è¡Œæ€§ï¼Œæä¾›å¹³è¡¡çš„å»ºè­°ã€‚å¦‚æœç©å®¶çš„æŒ‡ä»¤æ¶‰åŠèˆ‡æ‚¨çš„äº’å‹•ï¼Œè«‹ä»¥å‹™å¯¦çš„å°ˆæ¥­é¡§å•èº«ä»½å›æ‡‰ã€‚"
        };
        
        const eventCategoryIcons = {
            initial: 'ğŸŒ',
            producer: 'ğŸŒ±',
            primary: 'ğŸ¦‹', 
            secondary: 'ğŸº',
            decomposer: 'ğŸ„',
            climate: 'ğŸŒ¡ï¸',
            pollution: 'ğŸ­',
            human: 'ğŸ‘¥',
            natural: 'ğŸŒªï¸'
        };

        const ecosystemVisuals = {
            'æ£®æ—ç”Ÿæ…‹ç³»': 'ğŸŒ²ğŸ¦…ğŸ»ğŸ„',
            'è‰åŸç”Ÿæ…‹ç³»': 'ğŸŒ¾ğŸ¦ŒğŸºğŸ¦—', 
            'æ·¡æ°´ç”Ÿæ…‹ç³»': 'ğŸŒŠğŸŸğŸ¦†ğŸ¦ ',
            'æµ·æ´‹ç”Ÿæ…‹ç³»': 'ğŸŒŠğŸŸğŸ¦ˆğŸ¦ ',
            'æ¿•åœ°ç”Ÿæ…‹ç³»': 'ğŸŒ¾ğŸ¦†ğŸ¸ğŸ¦Ÿ',
            'æ²™æ¼ ç”Ÿæ…‹ç³»': 'ğŸŒµğŸ¦ğŸğŸ•·ï¸'
        };

        function showMessage(title, content, onConfirm, showCancel = false) {
            ui.messageTitle.textContent = title;
            ui.messageContent.innerHTML = content;
            ui.messageButton.textContent = "ç¢ºèª";
            ui.messageButton.onclick = () => {
                ui.messageModal.style.display = 'none';
                if (onConfirm) onConfirm();
            };
            const existingCancelBtn = ui.messageModal.querySelector('#message-cancel-button');
            if (showCancel && !existingCancelBtn) {
                const cancelButton = document.createElement('button');
                cancelButton.id = 'message-cancel-button';
                cancelButton.className = 'btn-secondary ml-3';
                cancelButton.textContent = "å–æ¶ˆ";
                cancelButton.onclick = () => {
                    ui.messageModal.style.display = 'none';
                };
                ui.messageModal.querySelector('.flex').appendChild(cancelButton);
            } else if (!showCancel && existingCancelBtn) {
                existingCancelBtn.remove();
            }
            ui.messageModal.style.display = 'flex';
        }
        
        function showHelpModal() {
            ui.helpModal.style.display = 'flex';
        }
        
        function closeHelpModal() {
            ui.helpModal.style.display = 'none';
        }
        
        function showTempMessage(message) {
            ui.tempMessage.textContent = message;
            ui.tempMessage.classList.add('show');
            setTimeout(() => {
                ui.tempMessage.classList.remove('show');
            }, 3000);
        }
        
        function updateEcosystemStatus() {
            const avgHealth = (gameState.producer + gameState.primary + gameState.secondary + gameState.decomposer) / 4;
            let status = '', color = '';
            
            if (avgHealth >= 80) {
                status = 'ç¹æ¦®ç©©å®š';
                color = 'text-green-400';
            } else if (avgHealth >= 60) {
                status = 'å¥åº·æ¢å¾©ä¸­';
                color = 'text-green-300';
            } else if (avgHealth >= 40) {
                status = 'è„†å¼±';
                color = 'text-yellow-400';
            } else if (avgHealth >= 20) {
                status = 'ç€•å±';
                color = 'text-orange-400';
            } else {
                status = 'æ¥µå±';
                color = 'text-red-400';
            }
            
            ui.ecosystemStatus.textContent = status;
            ui.ecosystemStatus.className = `font-bold ${color}`;
        }
        
        function updateUI() {
            ui.timeCount.textContent = gameState.time;
            ui.producerValue.textContent = gameState.producer;
            ui.primaryValue.textContent = gameState.primary;
            ui.secondaryValue.textContent = gameState.secondary;
            ui.decomposerValue.textContent = gameState.decomposer;
            
            ui.advisorDialogue.textContent = gameState.currentAdvisorDialogue;
            ui.eventDescription.textContent = gameState.currentEvent;
            ui.advisorPortrait.src = gameState.advisorPortraitUrl;
            ui.ecosystemTypeSelect.value = gameState.ecosystemType;
            ui.ecosystemTypeSelect.disabled = gameState.time > 0;
            ui.eventCategoryIcon.textContent = eventCategoryIcons[gameState.currentEventCategory] || 'â“';
            ui.apiKeyInput.value = gameState.geminiApiKey;
            ui.ecosystemEmoji.textContent = ecosystemVisuals[gameState.ecosystemType] || 'ğŸŒğŸŒ±ğŸ¦‹ğŸ„';
            
            updateEcosystemStatus();
            
            function updateStatBar(bar, value) {
                const percentage = Math.max(0, Math.min(100, value));
                bar.style.width = `${percentage}%`;
                bar.className = 'stat-fill';
                
                if (value <= 20) {
                    bar.classList.add('critical');
                } else if (value <= 40) {
                    bar.classList.add('warning');
                } else if (value <= 70) {
                    bar.classList.add('good');
                } else {
                    bar.classList.add('excellent');
                }
            }
            
            updateStatBar(ui.producerBar, gameState.producer);
            updateStatBar(ui.primaryBar, gameState.primary);
            updateStatBar(ui.secondaryBar, gameState.secondary);
            updateStatBar(ui.decomposerBar, gameState.decomposer);
            
            const isLoading = !ui.loadingIndicator.classList.contains('hidden');
            const isReadyForNewCycle = gameState.isCycleEnd && !isLoading;
            const isWaitingForDecision = !gameState.isCycleEnd && !isLoading;
            
            ui.decisionArea.style.display = isWaitingForDecision ? 'block' : 'none';
            ui.newEventBtn.style.display = isReadyForNewCycle ? 'block' : 'none';
            ui.newEventBtn.textContent = (gameState.time === 0) ? 'é–‹å§‹æ–°å‘¨æœŸ' : 'ä¸‹ä¸€å‘¨æœŸ';
            
            document.querySelectorAll('button').forEach(b => b.disabled = isLoading);
            ui.playerInput.disabled = isLoading || !isWaitingForDecision;
        }

        function checkGameEnd() {
            // æª¢æŸ¥ç”Ÿæ…‹ç³»çµ±å´©æ½°
            if (gameState.producer <= CRITICAL_THRESHOLD) {
                showMessage("ç”Ÿæ…‹ç³»çµ±å´©æ½°ï¼", `ç”Ÿç”¢è€…æ•¸é‡éä½ï¼Œæ•´å€‹é£Ÿç‰©éˆå´©æ½°äº†ï¼<br>æ‚¨å …æŒäº† ${gameState.time} å€‹æ™‚é–“å–®ä½ã€‚`, startNewGame);
                return true;
            }
            if (gameState.primary <= CRITICAL_THRESHOLD) {
                showMessage("ç”Ÿæ…‹ç³»çµ±å´©æ½°ï¼", `åˆç´šæ¶ˆè²»è€…æ»…çµ•ï¼Œç”Ÿæ…‹ç³»çµ±å¤±å»å¹³è¡¡ï¼<br>æ‚¨å …æŒäº† ${gameState.time} å€‹æ™‚é–“å–®ä½ã€‚`, startNewGame);
                return true;
            }
            if (gameState.secondary <= CRITICAL_THRESHOLD) {
                showMessage("ç”Ÿæ…‹ç³»çµ±å´©æ½°ï¼", `æ¬¡ç´šæ¶ˆè²»è€…æ¶ˆå¤±ï¼Œç”Ÿæ…‹éˆé ‚ç«¯æ–·è£‚ï¼<br>æ‚¨å …æŒäº† ${gameState.time} å€‹æ™‚é–“å–®ä½ã€‚`, startNewGame);
                return true;
            }
            if (gameState.decomposer <= CRITICAL_THRESHOLD) {
                showMessage("ç”Ÿæ…‹ç³»çµ±å´©æ½°ï¼", `åˆ†è§£è€…ç¼ºå¤±ï¼Œç‡Ÿé¤Šå¾ªç’°ä¸­æ–·ï¼<br>æ‚¨å …æŒäº† ${gameState.time} å€‹æ™‚é–“å–®ä½ã€‚`, startNewGame);
                return true;
            }
            
            // æª¢æŸ¥å‹åˆ©æ¢ä»¶
            if (gameState.producer >= RECOVERY_THRESHOLD && 
                gameState.primary >= RECOVERY_THRESHOLD && 
                gameState.secondary >= RECOVERY_THRESHOLD && 
                gameState.decomposer >= RECOVERY_THRESHOLD) {
                
                gameState.healthyTime = (gameState.healthyTime || 0) + 1;
                
                if (gameState.healthyTime >= VICTORY_TIME) {
                    showMessage("ä»»å‹™æˆåŠŸï¼", `ğŸ‰ æ­å–œï¼æ‚¨æˆåŠŸæ‹¯æ•‘äº†${gameState.ecosystemType}ï¼<br>ç”Ÿæ…‹ç³»çµ±å·²æ¢å¾©ç©©å®šå¹³è¡¡ï¼Œæ‰€æœ‰æŒ‡æ¨™ç¶­æŒå¥åº·æ°´æº–è¶…é${VICTORY_TIME}å€‹æ™‚é–“å–®ä½ã€‚<br>æ‚¨æ˜¯çœŸæ­£çš„ç”Ÿæ…‹å®ˆè­·è€…ï¼`, startNewGame);
                    return true;
                }
            } else {
                gameState.healthyTime = 0;
            }
            
            return false;
        }

        async function callGeminiAPI(prompt, schema = null) {
            if (!gameState.geminiApiKey) {
                showMessage("API Key ç¼ºå¤±", "è«‹å…ˆè¼¸å…¥æ‚¨çš„Gemini API Keyã€‚", () => {});
                return null;
            }
            
            ui.loadingIndicator.classList.remove('hidden');
            updateUI();
            
            try {
                const model = "gemini-2.0-flash";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${gameState.geminiApiKey}`;
                const payload = {
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }]
                };
                
                if (schema) {
                    payload.generationConfig = {
                        responseMimeType: "application/json",
                        responseSchema: schema
                    };
                }
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'æœªçŸ¥éŒ¯èª¤');
                }
                
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!text) {
                    throw new Error("AIæœªèƒ½è¿”å›æœ‰æ•ˆçš„æ–‡å­—å›æ‡‰ã€‚");
                }
                
                if (schema) {
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        throw new Error("AIæœªèƒ½è¿”å›é æœŸçš„JSONæ ¼å¼ã€‚");
                    }
                }
                
                return text;
            } catch (error) {
                console.error("API Call Failed:", error);
                // å¦‚æœæ˜¯ç¶²è·¯é™åˆ¶éŒ¯èª¤ï¼Œæä¾›è©³ç´°èªªæ˜
                if (error.message.includes('Failed to fetch')) {
                    showMessage("ç¶²è·¯è«‹æ±‚è¢«é˜»æ“‹", 
                        `æª¢æ¸¬åˆ°ç¶²è·¯è«‹æ±‚é™åˆ¶ã€‚å¯èƒ½çš„è§£æ±ºæ–¹æ¡ˆï¼š<br><br>
                        1. <b>ä½¿ç”¨ä»£ç†æœå‹™</b>ï¼šéƒ¨ç½²ä»£ç¢¼åˆ°æ”¯æ´ CORS çš„ä¼ºæœå™¨<br>
                        2. <b>æœ¬åœ°ç’°å¢ƒ</b>ï¼šåœ¨æœ¬åœ°ä¼ºæœå™¨åŸ·è¡Œä»£ç¢¼<br>
                        3. <b>ç€è¦½å™¨è¨­å®š</b>ï¼šæš«æ™‚åœç”¨ç€è¦½å™¨å®‰å…¨æ€§é™åˆ¶<br><br>
                        <b>è‡¨æ™‚æ–¹æ¡ˆ</b>ï¼šå°‡ä»£ç¢¼è¤‡è£½åˆ°æ‚¨è‡ªå·±çš„ç¶²é ç’°å¢ƒä¸­ä½¿ç”¨`, 
                        () => {});
                } else {
                    showMessage("API éŒ¯èª¤", `èˆ‡AIæºé€šå¤±æ•—ï¼š${error.message}`, () => {});
                }
                return null;
            } finally {
                ui.loadingIndicator.classList.add('hidden');
                updateUI();
            }
        }

        async function generateNewEvent() {
            gameState.isCycleEnd = false;
            gameState.time++;
            ui.statChangesDisplay.classList.add('hidden');
            updateUI();
            
            const historyText = gameState.eventHistory.map(e => 
                `T${e.time}: ${e.event_description} -> ${e.player_decision}`
            ).join('\n');
            const historyPrompt = historyText ? `\n\næ­·å²è¨˜éŒ„(æœ€è¿‘5æ¬¡):\n${historyText}\n` : '';
            
            const statContext = `ç•¶å‰ç”Ÿæ…‹æŒ‡æ¨™ï¼šç”Ÿç”¢è€… ${gameState.producer}%, åˆç´šæ¶ˆè²»è€… ${gameState.primary}%, æ¬¡ç´šæ¶ˆè²»è€… ${gameState.secondary}%, åˆ†è§£è€… ${gameState.decomposer}%ã€‚`;
            
            const timeContext = gameState.time <= 5 ? "åˆæœŸéšæ®µ" : gameState.time <= 15 ? "ä¸­æœŸç™¼å±•" : "å¾ŒæœŸé—œéµéšæ®µ";
            
            let eventPrompt = `æ‚¨æ˜¯å°ˆæ¥­çš„ç”Ÿæ…‹å­¸AIé¡§å•ã€‚${gameState.aiPersonaPrompt}

æˆ‘æ˜¯è² è²¬æ‹¯æ•‘${gameState.ecosystemType}çš„ç”Ÿæ…‹å­¸å®¶ï¼Œç›®å‰è™•æ–¼${timeContext}ã€‚${statContext}

è«‹ç‚ºç¬¬ ${gameState.time} å€‹æ™‚é–“å–®ä½ç”Ÿæˆä¸€å€‹çœŸå¯¦ä¸”å…·æŒ‘æˆ°æ€§çš„ç”Ÿæ…‹äº‹ä»¶ï¼š

è¦æ±‚ï¼š
1. äº‹ä»¶æ‡‰è©²åæ˜ çœŸå¯¦çš„ç”Ÿæ…‹å­¸å•é¡Œï¼ˆæ°£å€™è®Šé·ã€ç‰©ç¨®å…¥ä¾µã€æ£²åœ°ç ´å£ã€æ±¡æŸ“ã€äººé¡æ´»å‹•ç­‰ï¼‰
2. è€ƒæ…®ç•¶å‰ç”Ÿæ…‹æŒ‡æ¨™çš„ç‹€æ³ï¼Œç”Ÿæˆç›¸æ‡‰çš„ç·Šæ€¥æˆ–æ©Ÿæœƒäº‹ä»¶
3. äº‹ä»¶æè¿°è¦ç”Ÿå‹•å…·é«”ï¼Œè®“ç©å®¶æ„Ÿå—åˆ°çœŸå¯¦çš„ä¿è‚²æŒ‘æˆ°
4. é©åˆç”¨ã€Œå¯¦æ–½ã€æˆ–ã€Œæ‹’çµ•ã€å›ç­”ï¼Œä½†ä¹Ÿè¦èƒ½æ¥å—è©³ç´°ç­–ç•¥
5. é«”ç¾${gameState.ecosystemType}çš„ç‰¹æ®Šæ€§è³ªå’Œé¢è‡¨çš„ç‰¹å®šå¨è„…
6. ä¸è¦åœ¨äº‹ä»¶ä¸­é€éœ²æ•¸å€¼è®ŠåŒ–
7. è€ƒæ…®æ™‚é–“æ¼”è®Šæ€§ï¼æ—©æœŸå¯èƒ½æ˜¯é é˜²æ€§å•é¡Œï¼Œå¾ŒæœŸæ˜¯ç·Šæ€¥å±æ©Ÿ

äº‹ä»¶é¡å‹å¯ä»¥åŒ…æ‹¬ï¼š
- producer: æ¤ç‰©/è—»é¡ç›¸é—œï¼ˆæ£®æ—ç ä¼ã€å…¥ä¾µæ¤ç‰©ã€ç–¾ç—…ç­‰ï¼‰
- primary: è‰é£Ÿå‹•ç‰©/åˆç´šæ¶ˆè²»è€…ï¼ˆæ˜†èŸ²æ¸›å°‘ã€é·å¾™æ”¹è®Šç­‰ï¼‰  
- secondary: è‚‰é£Ÿå‹•ç‰©/æ¬¡ç´šæ¶ˆè²»è€…ï¼ˆæ•é£Ÿè€…æ•¸é‡ã€é ˜åŸŸçˆ­å¥ªç­‰ï¼‰
- decomposer: åˆ†è§£è€…å•é¡Œï¼ˆåœŸå£¤å¥åº·ã€å¾®ç”Ÿç‰©ç¾¤è½ç­‰ï¼‰
- climate: æ°£å€™ç›¸é—œï¼ˆæ¥µç«¯å¤©æ°£ã€æº«åº¦è®ŠåŒ–ã€é™é›¨æ¨¡å¼ç­‰ï¼‰
- pollution: æ±¡æŸ“å•é¡Œï¼ˆåŒ–å­¸æ±¡æŸ“ã€å¡‘è† åƒåœ¾ã€é‡é‡‘å±¬ç­‰ï¼‰
- human: äººé¡æ´»å‹•å½±éŸ¿ï¼ˆé–‹ç™¼ã€è§€å…‰ã€çµæ•ç­‰ï¼‰
- natural: è‡ªç„¶ç½å®³ï¼ˆç«ç½ã€æ´ªæ°´ã€ä¹¾æ—±ç­‰ï¼‰

è«‹ä»¥JSONæ ¼å¼å›å ±ï¼ŒåŒ…å«ï¼š
- event_description (150å­—å…§çš„è©³ç´°äº‹ä»¶æè¿°)
- event_category (å¾ä¸Šè¿°é¡å‹é¸æ“‡)  
- advisor_greeting (80å­—å…§çš„ç”Ÿæ…‹é¡§å•é–‹å ´ç™½)

${historyPrompt}`;
            
            const schema = {
                type: "OBJECT",
                properties: {
                    event_description: {type: "STRING"},
                    event_category: {type: "STRING"},
                    advisor_greeting: {type: "STRING"}
                },
                required: ["event_description", "event_category", "advisor_greeting"]
            };
            
            const aiResponse = await callGeminiAPI(eventPrompt, schema);
            
            if (aiResponse) {
                gameState.currentEvent = aiResponse.event_description;
                gameState.currentEventCategory = aiResponse.event_category;
                gameState.currentAdvisorDialogue = aiResponse.advisor_greeting;
                
                gameState.eventHistory.push({
                    time: gameState.time,
                    event_description: aiResponse.event_description,
                    player_decision: ""
                });
                
                if (gameState.eventHistory.length > 5) {
                    gameState.eventHistory.shift();
                }
            } else {
                gameState.time--;
                gameState.isCycleEnd = true;
            }
            
            updateUI();
        }

        async function submitDecision(decision) {
            const playerDecision = decision || ui.playerInput.value.trim();
            if (!playerDecision) return;
            
            ui.loadingIndicator.classList.remove('hidden');
            updateUI();
            
            if (gameState.eventHistory.length > 0) {
                gameState.eventHistory[gameState.eventHistory.length - 1].player_decision = playerDecision;
            }
            
            const decisionPrompt = `æ‚¨æ˜¯å°ˆæ¥­çš„ç”Ÿæ…‹å­¸AIé¡§å•ã€‚${gameState.aiPersonaPrompt}

ç”Ÿæ…‹äº‹ä»¶ï¼šã€Œ${gameState.currentEvent}ã€
æˆ‘çš„æ±ºç­–ï¼šã€Œ${playerDecision}ã€
ç”Ÿæ…‹ç³»çµ±ï¼š${gameState.ecosystemType}
ç•¶å‰ç‹€æ…‹ï¼šç”Ÿç”¢è€… ${gameState.producer}%, åˆç´šæ¶ˆè²»è€… ${gameState.primary}%, æ¬¡ç´šæ¶ˆè²»è€… ${gameState.secondary}%, åˆ†è§£è€… ${gameState.decomposer}%

è«‹æ ¹æ“šçœŸå¯¦çš„ç”Ÿæ…‹å­¸åŸç†ï¼Œåˆ†ææˆ‘çš„æ±ºç­–å°${gameState.ecosystemType}çš„å½±éŸ¿ï¼š

è€ƒæ…®å› ç´ ï¼š
1. ç”Ÿæ…‹ç³»çµ±çš„ç›¸äº’ä¾å­˜é—œä¿‚ï¼ˆé£Ÿç‰©éˆ/é£Ÿç‰©ç¶²æ•ˆæ‡‰ï¼‰
2. çŸ­æœŸvsé•·æœŸå½±éŸ¿
3. é€£é–åæ‡‰å’Œé–“æ¥æ•ˆæ‡‰
4. è³‡æºåˆ†é…å’Œç«¶çˆ­é—œä¿‚
5. ç’°å¢ƒæ‰¿è¼‰åŠ›è®ŠåŒ–
6. ç‰©ç¨®é©æ‡‰æ€§å’Œæ¼”åŒ–å£“åŠ›

æ•¸å€¼è®ŠåŒ–ç¯„åœï¼š-15åˆ°+15
- è€ƒæ…®æ±ºç­–çš„ç§‘å­¸åˆç†æ€§
- åæ˜ ç”Ÿæ…‹ç³»çµ±çš„è¤‡é›œæ€§å’Œä¸ç¢ºå®šæ€§
- å¹³è¡¡ç©æ¥µå’Œæ¶ˆæ¥µå½±éŸ¿
- é«”ç¾çœŸå¯¦ä¿è‚²å·¥ä½œçš„æŒ‘æˆ°

è«‹ä»¥JSONæ ¼å¼å›å ±ï¼š
- result_description (120å­—å…§çš„çµæœæè¿°ï¼Œè¦ç”Ÿå‹•å…·é«”)
- advisor_dialogue (80å­—å…§çš„ç”Ÿæ…‹é¡§å•å°ˆæ¥­å›æ‡‰)
- producer_change (ç”Ÿç”¢è€…æ•¸å€¼è®ŠåŒ–)
- primary_change (åˆç´šæ¶ˆè²»è€…æ•¸å€¼è®ŠåŒ–)  
- secondary_change (æ¬¡ç´šæ¶ˆè²»è€…æ•¸å€¼è®ŠåŒ–)
- decomposer_change (åˆ†è§£è€…æ•¸å€¼è®ŠåŒ–)`;
            
            const schema = {
                type: "OBJECT",
                properties: {
                    result_description: {type: "STRING"},
                    advisor_dialogue: {type: "STRING"},
                    producer_change: {type: "NUMBER"},
                    primary_change: {type: "NUMBER"},
                    secondary_change: {type: "NUMBER"},
                    decomposer_change: {type: "NUMBER"}
                },
                required: ["result_description", "advisor_dialogue", "producer_change", "primary_change", "secondary_change", "decomposer_change"]
            };
            
            const aiResponse = await callGeminiAPI(decisionPrompt, schema);
            
            if (aiResponse) {
                const changes = {
                    p: Math.max(-15, Math.min(15, aiResponse.producer_change || 0)),
                    pr: Math.max(-15, Math.min(15, aiResponse.primary_change || 0)),
                    s: Math.max(-15, Math.min(15, aiResponse.secondary_change || 0)),
                    d: Math.max(-15, Math.min(15, aiResponse.decomposer_change || 0))
                };
                
                gameState.producer += changes.p;
                gameState.primary += changes.pr;
                gameState.secondary += changes.s;
                gameState.decomposer += changes.d;
                
                // ç¢ºä¿æ•¸å€¼åœ¨0-100ç¯„åœå…§
                ['producer', 'primary', 'secondary', 'decomposer'].forEach(key => {
                    gameState[key] = Math.max(0, Math.min(100, gameState[key]));
                });
                
                let changesHtml = '<span>ç”Ÿæ…‹æŒ‡æ¨™è®ŠåŒ–ï¼š</span>';
                if (changes.p || changes.pr || changes.s || changes.d) {
                    if (changes.p) changesHtml += `<span class="${changes.p > 0 ? 'text-green-400' : 'text-red-400'} mr-3">ğŸŒ±${changes.p > 0 ? '+' : ''}${changes.p}</span>`;
                    if (changes.pr) changesHtml += `<span class="${changes.pr > 0 ? 'text-green-400' : 'text-red-400'} mr-3">ğŸ¦‹${changes.pr > 0 ? '+' : ''}${changes.pr}</span>`;
                    if (changes.s) changesHtml += `<span class="${changes.s > 0 ? 'text-green-400' : 'text-red-400'} mr-3">ğŸº${changes.s > 0 ? '+' : ''}${changes.s}</span>`;
                    if (changes.d) changesHtml += `<span class="${changes.d > 0 ? 'text-green-400' : 'text-red-400'}">ğŸ„${changes.d > 0 ? '+' : ''}${changes.d}</span>`;
                } else {
                    changesHtml = '<span>ç”Ÿæ…‹ç³»çµ±ç¶­æŒç¾ç‹€</span>';
                }
                
                ui.statChangesDisplay.innerHTML = changesHtml;
                ui.statChangesDisplay.classList.remove('hidden');
                
                gameState.currentEvent = aiResponse.result_description;
                gameState.currentAdvisorDialogue = aiResponse.advisor_dialogue;
                ui.playerInput.value = '';
                
                saveGame();
                
                if (checkGameEnd()) return;
                
                gameState.isCycleEnd = true;
            }
            
            updateUI();
        }

        function saveGame() {
            gameState.aiPersonaPrompt = ui.personaPrompt.value;
            gameState.ecosystemType = ui.ecosystemTypeSelect.value;
            // åœ¨å…§å­˜ä¸­ä¿å­˜ï¼Œç„¡éœ€localStorage
        }
        
        function loadGame() {
            const defaultState = {
                time: 0,
                producer: 30,
                primary: 25,
                secondary: 20,
                decomposer: 35,
                geminiApiKey: '',
                aiPersonaPrompt: presetPersonas['conservative'],
                currentEvent: "è«‹é»æ“Šã€Œé–‹å§‹æ–°å‘¨æœŸã€ä¾†æ¥æ”¶æœ€æ–°çš„ç”Ÿæ…‹ç›£æ¸¬å ±å‘Šã€‚",
                currentAdvisorDialogue: "åšå£«ï¼Œè«‹é–‹å§‹æ–°çš„æ™‚é–“å‘¨æœŸä»¥æ¥æ”¶ç”Ÿæ…‹ç›£æ¸¬å ±å‘Šã€‚",
                advisorPortraitUrl: defaultPortraits.scientist,
                isCycleEnd: true,
                ecosystemType: "æ£®æ—ç”Ÿæ…‹ç³»",
                eventHistory: [],
                currentEventCategory: 'initial',
                healthyTime: 0
            };
            
            // åªåœ¨éŠæˆ²ç‹€æ…‹ç‚ºç©ºæ™‚åˆå§‹åŒ–
            if (!gameState.time && gameState.time !== 0) {
                Object.assign(gameState, defaultState);
                if (isInitialLoad) {
                    showHelpModal();
                    isInitialLoad = false;
                }
            }
            
            ui.personaPrompt.value = gameState.aiPersonaPrompt || defaultState.aiPersonaPrompt;
            ui.apiKeyInput.value = gameState.geminiApiKey || '';
            updateUI();
        }
        
        function startNewGame() {
            const key = gameState.geminiApiKey;
            const persona = gameState.aiPersonaPrompt;
            const portrait = gameState.advisorPortraitUrl;
            
            gameState = {
                time: 0,
                producer: 30,
                primary: 25,
                secondary: 20,
                decomposer: 35,
                geminiApiKey: key,
                aiPersonaPrompt: persona,
                currentEvent: "è«‹é»æ“Šã€Œé–‹å§‹æ–°å‘¨æœŸã€ä¾†æ¥æ”¶æœ€æ–°çš„ç”Ÿæ…‹ç›£æ¸¬å ±å‘Šã€‚",
                currentAdvisorDialogue: "åšå£«ï¼Œè«‹é–‹å§‹æ–°çš„æ™‚é–“å‘¨æœŸä»¥æ¥æ”¶ç”Ÿæ…‹ç›£æ¸¬å ±å‘Šã€‚",
                advisorPortraitUrl: portrait,
                isCycleEnd: true,
                ecosystemType: "æ£®æ—ç”Ÿæ…‹ç³»",
                eventHistory: [],
                currentEventCategory: 'initial',
                healthyTime: 0
            };
            
            ui.statChangesDisplay.classList.add('hidden');
            saveGame();
            updateUI();
        }
        
        function setPortrait(url) {
            gameState.advisorPortraitUrl = url;
            updateUI();
            saveGame();
        }
        
        function init() {
            // æ‘ºç–Šé¢æ¿åŠŸèƒ½
            document.querySelectorAll('.collapsible-header').forEach(h => {
                h.addEventListener('click', () => {
                    const content = h.nextElementSibling;
                    const icon = h.querySelector('.collapsible-icon');
                    content.classList.toggle('expanded');
                    h.classList.toggle('expanded-header', content.classList.contains('expanded'));
                    if (icon) icon.classList.toggle('rotated', content.classList.contains('expanded'));
                });
            });
            
            // API Key è¨­å®š
            ui.saveApiKeyBtn.addEventListener('click', () => {
                const key = ui.apiKeyInput.value.trim();
                if (key) {
                    gameState.geminiApiKey = key;
                    showMessage("ä¿å­˜æˆåŠŸ", "API Key å·²ä¿å­˜ï¼", () => {});
                    saveGame();
                } else {
                    showMessage("è¼¸å…¥ç„¡æ•ˆ", "API Keyä¸èƒ½ç‚ºç©ºã€‚", () => {});
                }
                updateUI();
            });
            
            // å€‹æ€§é è¨­æŒ‰éˆ•
            ui.presetConservative.addEventListener('click', () => {
                ui.personaPrompt.value = presetPersonas['conservative'];
            });
            ui.presetActivist.addEventListener('click', () => {
                ui.personaPrompt.value = presetPersonas['activist'];
            });
            ui.presetPragmatic.addEventListener('click', () => {
                ui.personaPrompt.value = presetPersonas['pragmatic'];
            });
            
            ui.updatePersonaBtn.addEventListener('click', () => {
                const newPrompt = ui.personaPrompt.value.trim();
                if (newPrompt) {
                    gameState.aiPersonaPrompt = newPrompt;
                    saveGame();
                    showMessage("æ›´æ–°æˆåŠŸ", "AIç”Ÿæ…‹é¡§å•å€‹æ€§å·²æ›´æ–°ï¼", () => {});
                }
            });
            
            // é ­åƒè¨­å®š
            ui.setScientistPortraitBtn.addEventListener('click', () => setPortrait(defaultPortraits.scientist));
            ui.setActivistPortraitBtn.addEventListener('click', () => setPortrait(defaultPortraits.activist));
            ui.setResearcherPortraitBtn.addEventListener('click', () => setPortrait(defaultPortraits.researcher));
            
            ui.setUrlPortraitBtn.addEventListener('click', () => {
                const url = ui.portraitUrlInput.value.trim();
                if (url) {
                    setPortrait(url);
                    ui.portraitUrlInput.value = '';
                } else {
                    showMessage("ç¶²å€ç„¡æ•ˆ", "è«‹è¼¸å…¥æœ‰æ•ˆçš„åœ–ç‰‡ç¶²å€ã€‚", () => {});
                }
            });
            
            ui.uploadPortraitInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                if (!['image/jpeg', 'image/png'].includes(file.type)) {
                    showMessage("æ ¼å¼éŒ¯èª¤", "è«‹ä¸Šå‚³ .jpg æˆ– .png æ ¼å¼çš„åœ–ç‰‡ã€‚", () => {});
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (e.target.result.length > 1000 * 1024) {
                        showMessage("æª”æ¡ˆéå¤§", "åœ–ç‰‡æª”æ¡ˆå¤ªå¤§(>700KB)ï¼Œå¯èƒ½å°è‡´å­˜æª”å¤±æ•—ã€‚", () => {});
                        return;
                    }
                    setPortrait(e.target.result);
                };
                reader.readAsDataURL(file);
            });
            
            // éŠæˆ²æ§åˆ¶
            ui.newEventBtn.addEventListener('click', generateNewEvent);
            ui.yesBtn.addEventListener('click', () => submitDecision('å¯¦æ–½'));
            ui.noBtn.addEventListener('click', () => submitDecision('æ‹’çµ•'));
            ui.submitDecisionBtn.addEventListener('click', () => submitDecision());
            
            ui.playerInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    ui.submitDecisionBtn.click();
                }
            });
            
            // å…¶ä»–æŒ‰éˆ•
            ui.newGameBtn.addEventListener('click', () => 
                showMessage("ç¢ºèªé‡æ–°é–‹å§‹", "æ‚¨ç¢ºå®šè¦é‡æ–°é–‹å§‹ç”Ÿæ…‹ä¿è­·ä»»å‹™å—ï¼Ÿé€™æœƒé‡ç½®æ™‚é–“è»¸èˆ‡ç”Ÿæ…‹æŒ‡æ¨™ï¼Œä½†æœƒä¿ç•™æ‚¨çš„é¡§å•è¨­å®šã€‚", startNewGame, true)
            );
            
            ui.saveGameBtn.addEventListener('click', () => {
                saveGame();
                showTempMessage("éŠæˆ²ç‹€æ…‹å·²æ›´æ–°ï¼ˆæ³¨æ„ï¼šåœ¨æ­¤ç’°å¢ƒä¸­ç„¡æ³•æ°¸ä¹…ä¿å­˜ï¼‰");
            });
            
            ui.loadGameBtn.addEventListener('click', () => {
                loadGame();
                showTempMessage("éŠæˆ²ç‹€æ…‹å·²é‡æ–°è¼‰å…¥");
            });
            
            ui.openHelpBtn.addEventListener('click', showHelpModal);
            ui.closeHelpBtn.addEventListener('click', closeHelpModal);
            
            ui.helpModal.addEventListener('click', (event) => {
                if (event.target === ui.helpModal) {
                    closeHelpModal();
                }
            });
            
            ui.ecosystemTypeSelect.addEventListener('change', (e) => {
                gameState.ecosystemType = e.target.value;
                if (gameState.time > 0) saveGame();
                updateUI();
            });
            
            loadGame();
        }

        init();
    </script>
</body>
</html>