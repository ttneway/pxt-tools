        <div id="help-modal" class="modal"><div class="modal-content"><h3>遊戲說明</h3><h4>1. AI驅動的生態模擬</h4><p><b style="color: #10b981;">真實AI生成內容：</b>此遊戲使用 Gemini AI 即時生成多元化的生態事件和回應，每次遊戲體驗都獨一無二。<br><br><b>開始遊戲前請：</b><br>1. 取得免費的 Gemini API Key：<a href="https://lifecheatslab.com/freegeminiapi/" target="_blank" rel="noopener noreferrer">申請教學</a><br>2. 在設定區塊中輸入並保存您的 API Key<br>3. 如遇網路限制，請將代碼複製到您自己的環境</p><h4>2. 遊戲玩法</h4><ul><li>您扮演一位生態學家，負責拯救瀕危的生態系統。</li><li>AI會根據當前狀況生成真實的生態事件，每個事件都考慮了生態學原理。</li><li>您可以點擊「實施」或「拒絕」快速決策，或輸入詳細的保育策略。</li><li>AI會分析您的決策，根據生態系統相互依存關係調整四大指標。</li><li>事件會隨時間演變：早期是預防性問題，後期是緊急危機。</li></ul><h4>3. 四大生態指標</h4><ul><li><b>🌱 生產者</b>：植物、藻類等自營生物</li><li><b>🦋 初級消費者</b>：草食動物、浮游動物等</li><li><b>🐺 次級消費者</b>：肉食動物、頂級掠食者</li><li><b><!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>生態守護者 - 拯救瀕危生態系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #1e3a8a 0%, #059669 50%, #065f46 100%); color: #e2e8f0; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .game-container { width: 100%; max-width: 900px; background-color: rgba(45, 55, 72, 0.95); border-radius: 20px; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5); padding: 20px; display: flex; flex-direction: column; gap: 15px; backdrop-filter: blur(10px); }
        .stat-bar { height: 12px; background-color: #4a5568; border-radius: 6px; overflow: hidden; }
        .stat-fill { height: 100%; transition: width 0.5s ease-in-out; }
        .stat-fill.critical { background-color: #dc2626; }
        .stat-fill.warning { background-color: #f59e0b; }
        .stat-fill.good { background-color: #10b981; }
        .stat-fill.excellent { background-color: #059669; }
        button { padding: 10px 20px; border-radius: 10px; font-weight: bold; cursor: pointer; transition: all 0.2s ease-in-out; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2); font-size: 0.95rem; }
        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3); }
        button:disabled { cursor: not-allowed; opacity: 0.6; }
        .btn-primary { background-color: #10b981; color: white; border: none; }
        .btn-primary:hover:not(:disabled) { background-color: #059669; }
        .btn-secondary { background-color: #6b7280; color: white; border: none; }
        .btn-secondary:hover:not(:disabled) { background-color: #4b5563; }
        .btn-danger { background-color: #dc2626; color: white; border: none; }
        .btn-danger:hover:not(:disabled) { background-color: #b91c1c; }
        input[type="text"], input[type="password"], textarea, select { background-color: #4a5568; color: #e2e8f0; border: 1px solid #10b981; border-radius: 10px; padding: 10px 12px; width: 100%; box-sizing: border-box; outline: none; }
        input[type="file"] { display: none; }
        .file-upload-label { background-color: #6b7280; color: white; padding: 8px 12px; border-radius: 8px; cursor: pointer; text-align: center; display: block; }
        .file-upload-label:hover { background-color: #4b5563; }
        input:focus, textarea:focus, select:focus { border-color: #059669; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3); }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 999; display: none; justify-content: center; align-items: center; padding: 20px; }
        .modal-content { background-color: #2d3748; padding: 25px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.7); max-width: 600px; width: 100%; border: 2px solid #10b981; max-height: 90vh; overflow-y: auto; }
        .modal-content h3 { font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; color: #10b981;}
        .modal-content h4 { font-size: 1.2rem; font-weight: bold; margin-top: 1.5rem; margin-bottom: 0.5rem; color: #34d399; border-bottom: 1px solid #4a5568; padding-bottom: 0.25rem;}
        .modal-content p, .modal-content li { color: #e2e8f0; line-height: 1.6; }
        .modal-content ul { list-style-type: disc; padding-left: 20px; }
        .modal-content a { color: #10b981; text-decoration: underline; }
        .modal-content button { margin-top: 20px; }
        .collapsible-header { background-color: #374151; color: white; padding: 12px 20px; border-radius: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; transition: background-color 0.2s ease-in-out; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); }
        .collapsible-header.expanded-header { border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
        .collapsible-header:hover { background-color: #10b981; }
        .collapsible-content { padding: 0 15px; background-color: #2d3748; border-radius: 0 0 10px 10px; border: 1px solid #4a5568; border-top: none; overflow: hidden; max-height: 0; transition: max-height 0.3s ease-out, padding 0.3s ease-out, opacity 0.3s ease-out; opacity: 0; pointer-events: none; }
        .collapsible-content.expanded { max-height: 500px; padding: 15px; border-top: 1px solid #4a5568; opacity: 1; pointer-events: auto; }
        .collapsible-icon { transition: transform 0.3s ease-in-out; }
        .collapsible-icon.rotated { transform: rotate(90deg); }
        #advisor-portrait-img { width: 150px; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); }
        .event-description-text { font-size: 1.1rem; line-height: 1.6; color: #e2e8f0; white-space: pre-wrap; flex-grow: 1; overflow-y: auto; padding-right: 5px; }
        #stat-changes-display { background-color: rgba(0,0,0,0.3); border-radius: 8px; padding: 8px 12px; margin-top: 15px; font-size: 0.9rem; text-align: left; line-height: 1.5; }
        #temp-message { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background-color: #374151; color: white; padding: 8px 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3); z-index: 1001; opacity: 0; transition: opacity 0.5s ease-out; pointer-events: none; }
        #temp-message.show { opacity: 1; }
        .ecosystem-visual { background: linear-gradient(to bottom, #0ea5e9 0%, #10b981 30%, #059669 70%, #064e3b 100%); border-radius: 15px; padding: 20px; margin: 10px 0; text-align: center; font-size: 2rem; min-height: 120px; display: flex; align-items: center; justify-content: center; }
        .time-indicator { background-color: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; text-align: center; font-weight: bold; }
    </style>
</head>
<body class="antialiased">
    <div id="message-modal" class="modal"><div class="modal-content"><h3 id="message-title"></h3><p id="message-content"></p><div class="flex justify-center gap-4"><button class="btn-primary" id="message-button">確認</button></div></div></div>
            <div id="help-modal" class="modal"><div class="modal-content"><h3>遊戲說明</h3><h4>1. 關於此演示版本</h4><p><b style="color: #10b981;">此為演示版本：</b>由於 Claude.ai 環境限制，無法調用外部 API。遊戲使用預設的模擬事件和回應來展示玩法。<br><br><b>如需完整 AI 互動功能：</b><br>1. 複製此代碼到您自己的網頁環境<br>2. 取得 Gemini API Key：<a href="https://lifecheatslab.com/freegeminiapi/" target="_blank" rel="noopener noreferrer">免費申請教學</a><br>3. 啟用網路請求功能</p><h4>2. 遊戲玩法</h4><ul><li>您扮演一位生態學家，負責拯救瀕危的生態系統。</li><li>每個回合都會面臨一件生態事件，您需要做出決策來維持生態平衡。</li><li>您可以點擊「實施」或「拒絕」快速決策，或輸入詳細的保育策略。</li><li>您的每個決策都會影響生態系的四大指標：🌱生產者、🦋初級消費者、🐺次級消費者、🍄分解者。</li><li>請謹慎維持各項數值的平衡。任何一項過低都可能導致生態系統崩潰。</li></ul><h4>3. 生態系統類型</h4><ul><li><b>森林生態系</b>：豐富的植被層次與生物多樣性</li><li><b>草原生態系</b>：以草本植物為主的開闊生態系統</li><li><b>淡水生態系</b>：河流、湖泊等淡水環境</li><li><b>海洋生態系</b>：廣闊的海洋環境</li><li><b>濕地生態系</b>：水陸交界的獨特環境</li><li><b>沙漠生態系</b>：乾旱環境下的特殊生態系統</li></ul><h4>4. 勝利條件</h4><p>當所有生態指標維持在健康水準（70以上）超過20個時間單位時，您就成功拯救了生態系統！</p><div class="text-center"><button class="btn-primary" id="close-help-btn">開始體驗</button></div></div></div>
    <div id="temp-message"></div>

    <div class="game-container">
        <h1 class="text-3xl font-bold text-center mb-5">🌍 生態守護者 - 拯救瀕危生態系統</h1>
        
        <div class="mb-5 bg-gray-700 rounded-lg shadow-md">
            <div class="collapsible-header" id="api-key-header"><span>🔑 Gemini API Key 設定</span><svg class="collapsible-icon w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg></div>
            <div class="collapsible-content" id="api-key-content"><label for="gemini-api-key" class="block text-sm font-medium text-gray-300 mb-2">您的Gemini API Key:</label><div class="flex flex-col sm:flex-row gap-3"><input type="text" id="gemini-api-key" placeholder="在此輸入您的Gemini API Key" class="flex-grow"><button class="btn-primary" id="save-api-key-btn">保存API Key</button></div></div>
        </div>
        
        <div class="mb-5 bg-gray-700 rounded-lg shadow-md">
            <div class="collapsible-header" id="ai-persona-header"><span>🧬 AI生態顧問個性設定</span><svg class="collapsible-icon w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg></div>
            <div class="collapsible-content" id="ai-persona-content"><label for="ai-persona-prompt" class="block text-sm font-medium text-gray-300 mb-2">系統提詞:</label><textarea id="ai-persona-prompt" rows="4" class="w-full"></textarea><div class="flex flex-wrap gap-2 mt-3"><button id="preset-conservative" class="btn-secondary text-sm px-3 py-1">保守派生態學家</button><button id="preset-activist" class="btn-secondary text-sm px-3 py-1">激進環保主義者</button><button id="preset-pragmatic" class="btn-secondary text-sm px-3 py-1">實用主義者</button><button class="btn-primary" id="update-persona-btn">更新個性設定</button></div></div>
        </div>
        
        <div class="ecosystem-selector rounded-lg shadow-md mb-5">
            <label for="ecosystem-type" class="block text-sm font-medium text-gray-300 mb-2 text-center">🌍 目標生態系統:</label>
            <select id="ecosystem-type" class="w-full text-center"><option value="森林生態系" selected>🌲 森林生態系</option><option value="草原生態系">🌾 草原生態系</option><option value="淡水生態系">🏞️ 淡水生態系</option><option value="海洋生態系">🌊 海洋生態系</option><option value="濕地生態系">🦆 濕地生態系</option><option value="沙漠生態系">🏜️ 沙漠生態系</option></select>
        </div>

        <div class="ecosystem-visual" id="ecosystem-visual">
            <div id="ecosystem-emoji">🌲🦋🐺🍄</div>
        </div>

        <div class="time-indicator mb-4">
            <div class="text-lg font-bold">🕐 時間軸: 第 <span id="time-count">0</span> 個時間單位</div>
            <div class="text-sm mt-2">生態系統狀態: <span id="ecosystem-status" class="font-bold text-yellow-400">瀕危</span></div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-5">
            <div class="p-3 bg-gray-600 rounded-lg">
                <div class="flex justify-between text-sm font-medium mb-1"><span>🌱 生產者</span><span id="producer-bar-value">30</span></div>
                <div class="stat-bar"><div id="producer-bar" class="stat-fill" style="width: 30%;"></div></div>
            </div>
            <div class="p-3 bg-gray-600 rounded-lg">
                <div class="flex justify-between text-sm font-medium mb-1"><span>🦋 初級消費者</span><span id="primary-bar-value">25</span></div>
                <div class="stat-bar"><div id="primary-bar" class="stat-fill" style="width: 25%;"></div></div>
            </div>
            <div class="p-3 bg-gray-600 rounded-lg">
                <div class="flex justify-between text-sm font-medium mb-1"><span>🐺 次級消費者</span><span id="secondary-bar-value">20</span></div>
                <div class="stat-bar"><div id="secondary-bar" class="stat-fill" style="width: 20%;"></div></div>
            </div>
            <div class="p-3 bg-gray-600 rounded-lg">
                <div class="flex justify-between text-sm font-medium mb-1"><span>🍄 分解者</span><span id="decomposer-bar-value">35</span></div>
                <div class="stat-bar"><div id="decomposer-bar" class="stat-fill" style="width: 35%;"></div></div>
            </div>
        </div>

        <div class="flex flex-col sm:flex-row gap-4 mb-5">
            <div class="w-full sm:w-1/3 bg-gray-600 rounded-lg p-3 flex flex-col items-center justify-start">
                <img id="advisor-portrait-img" src="https://i.ibb.co/TYpZx1z/eco-scientist.jpg" alt="生態顧問">
                <div class="w-full mt-2 space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">選擇預設形象:</label>
                        <div class="flex justify-around gap-2">
                            <button id="set-scientist-portrait" class="btn-secondary text-sm flex-1">科學家</button>
                            <button id="set-activist-portrait" class="btn-secondary text-sm flex-1">活動家</button>
                            <button id="set-researcher-portrait" class="btn-secondary text-sm flex-1">研究員</button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">自訂形象 (建議150x200px):</label>
                        <label for="upload-portrait-input" class="file-upload-label text-sm">上傳檔案 (.png, .jpg)</label>
                        <input type="file" id="upload-portrait-input" accept="image/png, image/jpeg">
                    </div>
                    <div class="collapsible-header" id="url-portrait-header">
                        <span>使用網址設定</span>
                        <svg class="collapsible-icon w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <div class="collapsible-content" id="url-portrait-content">
                        <input type="text" id="portrait-url-input" placeholder="貼上圖片網址(URL)..." class="text-sm">
                        <button id="set-url-portrait-btn" class="btn-primary w-full mt-2 text-sm">設定網址形象</button>
                    </div>
                </div>
            </div>
            
            <div class="w-full sm:w-2/3 bg-gray-700/50 rounded-lg p-4 flex flex-col">
                <div class="advisor-dialogue-area bg-gray-800/30 mb-4">
                    <p id="advisor-dialogue-text" class="advisor-dialogue-text">博士，請開始新的時間周期以接收生態監測報告。</p>
                </div>
                <div class="event-display-area bg-gray-800/30 flex-grow">
                    <h2 class="text-xl font-bold mb-3 flex items-center justify-center gap-3">
                        <span id="event-category-icon" class="text-2xl">🌍</span>
                        <span>生態事件報告</span>
                    </h2>
                    <p id="event-description-text" class="event-description-text">請點擊「開始新周期」來接收最新的生態監測報告。</p>
                    <div id="stat-changes-display" class="hidden w-full"></div>
                    <div id="loading-indicator" class="loading-indicator hidden">
                        <svg class="animate-spin h-5 w-5 text-green-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                </div>
                <button class="btn-primary mt-4" id="new-event-btn">開始新周期</button>
            </div>
        </div>

        <div id="decision-area" class="input-area mb-5">
            <div class="flex gap-4 mb-3">
                <button id="yes-btn" class="btn-primary flex-1">實施</button>
                <button id="no-btn" class="btn-danger flex-1">拒絕</button>
            </div>
            <input type="text" id="player-input" placeholder="或在此輸入您的詳細保育策略..." class="mb-3">
            <button class="btn-primary w-full" id="submit-decision-btn">執行策略</button>
        </div>

        <div class="flex flex-wrap justify-center gap-4">
            <button class="btn-secondary" id="open-help-btn">遊戲說明</button>
            <button class="btn-secondary" id="save-game-btn">保存進度</button>
            <button class="btn-secondary" id="load-game-btn">載入進度</button>
            <button class="btn-secondary" id="new-game-btn">重新開始</button>
        </div>
    </div>

    <script type="module">
        const ui = {
            timeCount: document.getElementById('time-count'),
            ecosystemStatus: document.getElementById('ecosystem-status'),
            producerValue: document.getElementById('producer-bar-value'),
            primaryValue: document.getElementById('primary-bar-value'), 
            secondaryValue: document.getElementById('secondary-bar-value'),
            decomposerValue: document.getElementById('decomposer-bar-value'),
            producerBar: document.getElementById('producer-bar'),
            primaryBar: document.getElementById('primary-bar'),
            secondaryBar: document.getElementById('secondary-bar'),
            decomposerBar: document.getElementById('decomposer-bar'),
            advisorDialogue: document.getElementById('advisor-dialogue-text'),
            eventDescription: document.getElementById('event-description-text'),
            playerInput: document.getElementById('player-input'),
            submitDecisionBtn: document.getElementById('submit-decision-btn'),
            newEventBtn: document.getElementById('new-event-btn'),
            yesBtn: document.getElementById('yes-btn'),
            noBtn: document.getElementById('no-btn'),
            loadingIndicator: document.getElementById('loading-indicator'),
            apiKeyInput: document.getElementById('gemini-api-key'),
            saveApiKeyBtn: document.getElementById('save-api-key-btn'),
            personaPrompt: document.getElementById('ai-persona-prompt'),
            updatePersonaBtn: document.getElementById('update-persona-btn'),
            advisorPortrait: document.getElementById('advisor-portrait-img'),
            setScientistPortraitBtn: document.getElementById('set-scientist-portrait'),
            setActivistPortraitBtn: document.getElementById('set-activist-portrait'),
            setResearcherPortraitBtn: document.getElementById('set-researcher-portrait'),
            uploadPortraitInput: document.getElementById('upload-portrait-input'),
            portraitUrlInput: document.getElementById('portrait-url-input'),
            setUrlPortraitBtn: document.getElementById('set-url-portrait-btn'),
            decisionArea: document.getElementById('decision-area'),
            ecosystemTypeSelect: document.getElementById('ecosystem-type'),
            saveGameBtn: document.getElementById('save-game-btn'),
            loadGameBtn: document.getElementById('load-game-btn'),
            newGameBtn: document.getElementById('new-game-btn'),
            messageModal: document.getElementById('message-modal'),
            messageTitle: document.getElementById('message-title'),
            messageContent: document.getElementById('message-content'),
            messageButton: document.getElementById('message-button'),
            helpModal: document.getElementById('help-modal'),
            openHelpBtn: document.getElementById('open-help-btn'),
            closeHelpBtn: document.getElementById('close-help-btn'),
            tempMessage: document.getElementById('temp-message'),
            presetConservative: document.getElementById('preset-conservative'),
            presetActivist: document.getElementById('preset-activist'),
            presetPragmatic: document.getElementById('preset-pragmatic'),
            statChangesDisplay: document.getElementById('stat-changes-display'),
            eventCategoryIcon: document.getElementById('event-category-icon'),
            ecosystemVisual: document.getElementById('ecosystem-visual'),
            ecosystemEmoji: document.getElementById('ecosystem-emoji'),
        };
        
        let gameState = {};
        let isInitialLoad = true;
        
        const STAT_MAX = 100, STAT_MIN = 0;
        const CRITICAL_THRESHOLD = 15;
        const RECOVERY_THRESHOLD = 70;
        const VICTORY_TIME = 20;
        
        const defaultPortraits = {
            scientist: 'https://i.ibb.co/TYpZx1z/eco-scientist.jpg',
            activist: 'https://i.ibb.co/ZGJxq1m/eco-activist.jpg', 
            researcher: 'https://i.ibb.co/rmvK8yh/eco-researcher.jpg'
        };
        
        const presetPersonas = {
            'conservative': "您是一位謹慎保守的生態學家，強調科學證據和長期研究，偏好循序漸進的保育方法。您的建議基於嚴謹的科學原理，不會冒險採用未經證實的方法。如果玩家的指令涉及與您的互動，請以專業而謹慎的生態學家身份回應。",
            'activist': "您是一位激進的環保主義者，深信需要大膽行動來拯救生態系統。您願意採用創新但有風險的方法，認為緊急情況需要緊急手段。您的建議充滿熱情但也充滿挑戰性。如果玩家的指令涉及與您的互動，請以充滿熱忱的環保活動家身份回應。",
            'pragmatic': "您是一位實用主義的生態顧問，平衡科學性與實用性，能夠在理想與現實之間找到可行的解決方案。您考慮資源限制和實施可行性，提供平衡的建議。如果玩家的指令涉及與您的互動，請以務實的專業顧問身份回應。"
        };
        
        const eventCategoryIcons = {
            initial: '🌍',
            producer: '🌱',
            primary: '🦋', 
            secondary: '🐺',
            decomposer: '🍄',
            climate: '🌡️',
            pollution: '🏭',
            human: '👥',
            natural: '🌪️'
        };

        const ecosystemVisuals = {
            '森林生態系': '🌲🦅🐻🍄',
            '草原生態系': '🌾🦌🐺🦗', 
            '淡水生態系': '🌊🐟🦆🦠',
            '海洋生態系': '🌊🐟🦈🦠',
            '濕地生態系': '🌾🦆🐸🦟',
            '沙漠生態系': '🌵🦎🐍🕷️'
        };

        function showMessage(title, content, onConfirm, showCancel = false) {
            ui.messageTitle.textContent = title;
            ui.messageContent.innerHTML = content;
            ui.messageButton.textContent = "確認";
            ui.messageButton.onclick = () => {
                ui.messageModal.style.display = 'none';
                if (onConfirm) onConfirm();
            };
            const existingCancelBtn = ui.messageModal.querySelector('#message-cancel-button');
            if (showCancel && !existingCancelBtn) {
                const cancelButton = document.createElement('button');
                cancelButton.id = 'message-cancel-button';
                cancelButton.className = 'btn-secondary ml-3';
                cancelButton.textContent = "取消";
                cancelButton.onclick = () => {
                    ui.messageModal.style.display = 'none';
                };
                ui.messageModal.querySelector('.flex').appendChild(cancelButton);
            } else if (!showCancel && existingCancelBtn) {
                existingCancelBtn.remove();
            }
            ui.messageModal.style.display = 'flex';
        }
        
        function showHelpModal() {
            ui.helpModal.style.display = 'flex';
        }
        
        function closeHelpModal() {
            ui.helpModal.style.display = 'none';
        }
        
        function showTempMessage(message) {
            ui.tempMessage.textContent = message;
            ui.tempMessage.classList.add('show');
            setTimeout(() => {
                ui.tempMessage.classList.remove('show');
            }, 3000);
        }
        
        function updateEcosystemStatus() {
            const avgHealth = (gameState.producer + gameState.primary + gameState.secondary + gameState.decomposer) / 4;
            let status = '', color = '';
            
            if (avgHealth >= 80) {
                status = '繁榮穩定';
                color = 'text-green-400';
            } else if (avgHealth >= 60) {
                status = '健康恢復中';
                color = 'text-green-300';
            } else if (avgHealth >= 40) {
                status = '脆弱';
                color = 'text-yellow-400';
            } else if (avgHealth >= 20) {
                status = '瀕危';
                color = 'text-orange-400';
            } else {
                status = '極危';
                color = 'text-red-400';
            }
            
            ui.ecosystemStatus.textContent = status;
            ui.ecosystemStatus.className = `font-bold ${color}`;
        }
        
        function updateUI() {
            ui.timeCount.textContent = gameState.time;
            ui.producerValue.textContent = gameState.producer;
            ui.primaryValue.textContent = gameState.primary;
            ui.secondaryValue.textContent = gameState.secondary;
            ui.decomposerValue.textContent = gameState.decomposer;
            
            ui.advisorDialogue.textContent = gameState.currentAdvisorDialogue;
            ui.eventDescription.textContent = gameState.currentEvent;
            ui.advisorPortrait.src = gameState.advisorPortraitUrl;
            ui.ecosystemTypeSelect.value = gameState.ecosystemType;
            ui.ecosystemTypeSelect.disabled = gameState.time > 0;
            ui.eventCategoryIcon.textContent = eventCategoryIcons[gameState.currentEventCategory] || '❓';
            ui.apiKeyInput.value = gameState.geminiApiKey;
            ui.ecosystemEmoji.textContent = ecosystemVisuals[gameState.ecosystemType] || '🌍🌱🦋🍄';
            
            updateEcosystemStatus();
            
            function updateStatBar(bar, value) {
                const percentage = Math.max(0, Math.min(100, value));
                bar.style.width = `${percentage}%`;
                bar.className = 'stat-fill';
                
                if (value <= 20) {
                    bar.classList.add('critical');
                } else if (value <= 40) {
                    bar.classList.add('warning');
                } else if (value <= 70) {
                    bar.classList.add('good');
                } else {
                    bar.classList.add('excellent');
                }
            }
            
            updateStatBar(ui.producerBar, gameState.producer);
            updateStatBar(ui.primaryBar, gameState.primary);
            updateStatBar(ui.secondaryBar, gameState.secondary);
            updateStatBar(ui.decomposerBar, gameState.decomposer);
            
            const isLoading = !ui.loadingIndicator.classList.contains('hidden');
            const isReadyForNewCycle = gameState.isCycleEnd && !isLoading;
            const isWaitingForDecision = !gameState.isCycleEnd && !isLoading;
            
            ui.decisionArea.style.display = isWaitingForDecision ? 'block' : 'none';
            ui.newEventBtn.style.display = isReadyForNewCycle ? 'block' : 'none';
            ui.newEventBtn.textContent = (gameState.time === 0) ? '開始新周期' : '下一周期';
            
            document.querySelectorAll('button').forEach(b => b.disabled = isLoading);
            ui.playerInput.disabled = isLoading || !isWaitingForDecision;
        }

        function checkGameEnd() {
            // 檢查生態系統崩潰
            if (gameState.producer <= CRITICAL_THRESHOLD) {
                showMessage("生態系統崩潰！", `生產者數量過低，整個食物鏈崩潰了！<br>您堅持了 ${gameState.time} 個時間單位。`, startNewGame);
                return true;
            }
            if (gameState.primary <= CRITICAL_THRESHOLD) {
                showMessage("生態系統崩潰！", `初級消費者滅絕，生態系統失去平衡！<br>您堅持了 ${gameState.time} 個時間單位。`, startNewGame);
                return true;
            }
            if (gameState.secondary <= CRITICAL_THRESHOLD) {
                showMessage("生態系統崩潰！", `次級消費者消失，生態鏈頂端斷裂！<br>您堅持了 ${gameState.time} 個時間單位。`, startNewGame);
                return true;
            }
            if (gameState.decomposer <= CRITICAL_THRESHOLD) {
                showMessage("生態系統崩潰！", `分解者缺失，營養循環中斷！<br>您堅持了 ${gameState.time} 個時間單位。`, startNewGame);
                return true;
            }
            
            // 檢查勝利條件
            if (gameState.producer >= RECOVERY_THRESHOLD && 
                gameState.primary >= RECOVERY_THRESHOLD && 
                gameState.secondary >= RECOVERY_THRESHOLD && 
                gameState.decomposer >= RECOVERY_THRESHOLD) {
                
                gameState.healthyTime = (gameState.healthyTime || 0) + 1;
                
                if (gameState.healthyTime >= VICTORY_TIME) {
                    showMessage("任務成功！", `🎉 恭喜！您成功拯救了${gameState.ecosystemType}！<br>生態系統已恢復穩定平衡，所有指標維持健康水準超過${VICTORY_TIME}個時間單位。<br>您是真正的生態守護者！`, startNewGame);
                    return true;
                }
            } else {
                gameState.healthyTime = 0;
            }
            
            return false;
        }

        async function callGeminiAPI(prompt, schema = null) {
            if (!gameState.geminiApiKey) {
                showMessage("API Key 缺失", "請先輸入您的Gemini API Key。", () => {});
                return null;
            }
            
            ui.loadingIndicator.classList.remove('hidden');
            updateUI();
            
            try {
                const model = "gemini-2.0-flash";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${gameState.geminiApiKey}`;
                const payload = {
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }]
                };
                
                if (schema) {
                    payload.generationConfig = {
                        responseMimeType: "application/json",
                        responseSchema: schema
                    };
                }
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || '未知錯誤');
                }
                
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!text) {
                    throw new Error("AI未能返回有效的文字回應。");
                }
                
                if (schema) {
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        throw new Error("AI未能返回預期的JSON格式。");
                    }
                }
                
                return text;
            } catch (error) {
                console.error("API Call Failed:", error);
                // 如果是網路限制錯誤，提供詳細說明
                if (error.message.includes('Failed to fetch')) {
                    showMessage("網路請求被阻擋", 
                        `檢測到網路請求限制。可能的解決方案：<br><br>
                        1. <b>使用代理服務</b>：部署代碼到支援 CORS 的伺服器<br>
                        2. <b>本地環境</b>：在本地伺服器執行代碼<br>
                        3. <b>瀏覽器設定</b>：暫時停用瀏覽器安全性限制<br><br>
                        <b>臨時方案</b>：將代碼複製到您自己的網頁環境中使用`, 
                        () => {});
                } else {
                    showMessage("API 錯誤", `與AI溝通失敗：${error.message}`, () => {});
                }
                return null;
            } finally {
                ui.loadingIndicator.classList.add('hidden');
                updateUI();
            }
        }

        async function generateNewEvent() {
            gameState.isCycleEnd = false;
            gameState.time++;
            ui.statChangesDisplay.classList.add('hidden');
            updateUI();
            
            const historyText = gameState.eventHistory.map(e => 
                `T${e.time}: ${e.event_description} -> ${e.player_decision}`
            ).join('\n');
            const historyPrompt = historyText ? `\n\n歷史記錄(最近5次):\n${historyText}\n` : '';
            
            const statContext = `當前生態指標：生產者 ${gameState.producer}%, 初級消費者 ${gameState.primary}%, 次級消費者 ${gameState.secondary}%, 分解者 ${gameState.decomposer}%。`;
            
            const timeContext = gameState.time <= 5 ? "初期階段" : gameState.time <= 15 ? "中期發展" : "後期關鍵階段";
            
            let eventPrompt = `您是專業的生態學AI顧問。${gameState.aiPersonaPrompt}

我是負責拯救${gameState.ecosystemType}的生態學家，目前處於${timeContext}。${statContext}

請為第 ${gameState.time} 個時間單位生成一個真實且具挑戰性的生態事件：

要求：
1. 事件應該反映真實的生態學問題（氣候變遷、物種入侵、棲地破壞、污染、人類活動等）
2. 考慮當前生態指標的狀況，生成相應的緊急或機會事件
3. 事件描述要生動具體，讓玩家感受到真實的保育挑戰
4. 適合用「實施」或「拒絕」回答，但也要能接受詳細策略
5. 體現${gameState.ecosystemType}的特殊性質和面臨的特定威脅
6. 不要在事件中透露數值變化
7. 考慮時間演變性－早期可能是預防性問題，後期是緊急危機

事件類型可以包括：
- producer: 植物/藻類相關（森林砍伐、入侵植物、疾病等）
- primary: 草食動物/初級消費者（昆蟲減少、遷徙改變等）  
- secondary: 肉食動物/次級消費者（捕食者數量、領域爭奪等）
- decomposer: 分解者問題（土壤健康、微生物群落等）
- climate: 氣候相關（極端天氣、溫度變化、降雨模式等）
- pollution: 污染問題（化學污染、塑膠垃圾、重金屬等）
- human: 人類活動影響（開發、觀光、獵捕等）
- natural: 自然災害（火災、洪水、乾旱等）

請以JSON格式回報，包含：
- event_description (150字內的詳細事件描述)
- event_category (從上述類型選擇)  
- advisor_greeting (80字內的生態顧問開場白)

${historyPrompt}`;
            
            const schema = {
                type: "OBJECT",
                properties: {
                    event_description: {type: "STRING"},
                    event_category: {type: "STRING"},
                    advisor_greeting: {type: "STRING"}
                },
                required: ["event_description", "event_category", "advisor_greeting"]
            };
            
            const aiResponse = await callGeminiAPI(eventPrompt, schema);
            
            if (aiResponse) {
                gameState.currentEvent = aiResponse.event_description;
                gameState.currentEventCategory = aiResponse.event_category;
                gameState.currentAdvisorDialogue = aiResponse.advisor_greeting;
                
                gameState.eventHistory.push({
                    time: gameState.time,
                    event_description: aiResponse.event_description,
                    player_decision: ""
                });
                
                if (gameState.eventHistory.length > 5) {
                    gameState.eventHistory.shift();
                }
            } else {
                gameState.time--;
                gameState.isCycleEnd = true;
            }
            
            updateUI();
        }

        async function submitDecision(decision) {
            const playerDecision = decision || ui.playerInput.value.trim();
            if (!playerDecision) return;
            
            ui.loadingIndicator.classList.remove('hidden');
            updateUI();
            
            if (gameState.eventHistory.length > 0) {
                gameState.eventHistory[gameState.eventHistory.length - 1].player_decision = playerDecision;
            }
            
            const decisionPrompt = `您是專業的生態學AI顧問。${gameState.aiPersonaPrompt}

生態事件：「${gameState.currentEvent}」
我的決策：「${playerDecision}」
生態系統：${gameState.ecosystemType}
當前狀態：生產者 ${gameState.producer}%, 初級消費者 ${gameState.primary}%, 次級消費者 ${gameState.secondary}%, 分解者 ${gameState.decomposer}%

請根據真實的生態學原理，分析我的決策對${gameState.ecosystemType}的影響：

考慮因素：
1. 生態系統的相互依存關係（食物鏈/食物網效應）
2. 短期vs長期影響
3. 連鎖反應和間接效應
4. 資源分配和競爭關係
5. 環境承載力變化
6. 物種適應性和演化壓力

數值變化範圍：-15到+15
- 考慮決策的科學合理性
- 反映生態系統的複雜性和不確定性
- 平衡積極和消極影響
- 體現真實保育工作的挑戰

請以JSON格式回報：
- result_description (120字內的結果描述，要生動具體)
- advisor_dialogue (80字內的生態顧問專業回應)
- producer_change (生產者數值變化)
- primary_change (初級消費者數值變化)  
- secondary_change (次級消費者數值變化)
- decomposer_change (分解者數值變化)`;
            
            const schema = {
                type: "OBJECT",
                properties: {
                    result_description: {type: "STRING"},
                    advisor_dialogue: {type: "STRING"},
                    producer_change: {type: "NUMBER"},
                    primary_change: {type: "NUMBER"},
                    secondary_change: {type: "NUMBER"},
                    decomposer_change: {type: "NUMBER"}
                },
                required: ["result_description", "advisor_dialogue", "producer_change", "primary_change", "secondary_change", "decomposer_change"]
            };
            
            const aiResponse = await callGeminiAPI(decisionPrompt, schema);
            
            if (aiResponse) {
                const changes = {
                    p: Math.max(-15, Math.min(15, aiResponse.producer_change || 0)),
                    pr: Math.max(-15, Math.min(15, aiResponse.primary_change || 0)),
                    s: Math.max(-15, Math.min(15, aiResponse.secondary_change || 0)),
                    d: Math.max(-15, Math.min(15, aiResponse.decomposer_change || 0))
                };
                
                gameState.producer += changes.p;
                gameState.primary += changes.pr;
                gameState.secondary += changes.s;
                gameState.decomposer += changes.d;
                
                // 確保數值在0-100範圍內
                ['producer', 'primary', 'secondary', 'decomposer'].forEach(key => {
                    gameState[key] = Math.max(0, Math.min(100, gameState[key]));
                });
                
                let changesHtml = '<span>生態指標變化：</span>';
                if (changes.p || changes.pr || changes.s || changes.d) {
                    if (changes.p) changesHtml += `<span class="${changes.p > 0 ? 'text-green-400' : 'text-red-400'} mr-3">🌱${changes.p > 0 ? '+' : ''}${changes.p}</span>`;
                    if (changes.pr) changesHtml += `<span class="${changes.pr > 0 ? 'text-green-400' : 'text-red-400'} mr-3">🦋${changes.pr > 0 ? '+' : ''}${changes.pr}</span>`;
                    if (changes.s) changesHtml += `<span class="${changes.s > 0 ? 'text-green-400' : 'text-red-400'} mr-3">🐺${changes.s > 0 ? '+' : ''}${changes.s}</span>`;
                    if (changes.d) changesHtml += `<span class="${changes.d > 0 ? 'text-green-400' : 'text-red-400'}">🍄${changes.d > 0 ? '+' : ''}${changes.d}</span>`;
                } else {
                    changesHtml = '<span>生態系統維持現狀</span>';
                }
                
                ui.statChangesDisplay.innerHTML = changesHtml;
                ui.statChangesDisplay.classList.remove('hidden');
                
                gameState.currentEvent = aiResponse.result_description;
                gameState.currentAdvisorDialogue = aiResponse.advisor_dialogue;
                ui.playerInput.value = '';
                
                saveGame();
                
                if (checkGameEnd()) return;
                
                gameState.isCycleEnd = true;
            }
            
            updateUI();
        }

        function saveGame() {
            gameState.aiPersonaPrompt = ui.personaPrompt.value;
            gameState.ecosystemType = ui.ecosystemTypeSelect.value;
            // 在內存中保存，無需localStorage
        }
        
        function loadGame() {
            const defaultState = {
                time: 0,
                producer: 30,
                primary: 25,
                secondary: 20,
                decomposer: 35,
                geminiApiKey: '',
                aiPersonaPrompt: presetPersonas['conservative'],
                currentEvent: "請點擊「開始新周期」來接收最新的生態監測報告。",
                currentAdvisorDialogue: "博士，請開始新的時間周期以接收生態監測報告。",
                advisorPortraitUrl: defaultPortraits.scientist,
                isCycleEnd: true,
                ecosystemType: "森林生態系",
                eventHistory: [],
                currentEventCategory: 'initial',
                healthyTime: 0
            };
            
            // 只在遊戲狀態為空時初始化
            if (!gameState.time && gameState.time !== 0) {
                Object.assign(gameState, defaultState);
                if (isInitialLoad) {
                    showHelpModal();
                    isInitialLoad = false;
                }
            }
            
            ui.personaPrompt.value = gameState.aiPersonaPrompt || defaultState.aiPersonaPrompt;
            ui.apiKeyInput.value = gameState.geminiApiKey || '';
            updateUI();
        }
        
        function startNewGame() {
            const key = gameState.geminiApiKey;
            const persona = gameState.aiPersonaPrompt;
            const portrait = gameState.advisorPortraitUrl;
            
            gameState = {
                time: 0,
                producer: 30,
                primary: 25,
                secondary: 20,
                decomposer: 35,
                geminiApiKey: key,
                aiPersonaPrompt: persona,
                currentEvent: "請點擊「開始新周期」來接收最新的生態監測報告。",
                currentAdvisorDialogue: "博士，請開始新的時間周期以接收生態監測報告。",
                advisorPortraitUrl: portrait,
                isCycleEnd: true,
                ecosystemType: "森林生態系",
                eventHistory: [],
                currentEventCategory: 'initial',
                healthyTime: 0
            };
            
            ui.statChangesDisplay.classList.add('hidden');
            saveGame();
            updateUI();
        }
        
        function setPortrait(url) {
            gameState.advisorPortraitUrl = url;
            updateUI();
            saveGame();
        }
        
        function init() {
            // 摺疊面板功能
            document.querySelectorAll('.collapsible-header').forEach(h => {
                h.addEventListener('click', () => {
                    const content = h.nextElementSibling;
                    const icon = h.querySelector('.collapsible-icon');
                    content.classList.toggle('expanded');
                    h.classList.toggle('expanded-header', content.classList.contains('expanded'));
                    if (icon) icon.classList.toggle('rotated', content.classList.contains('expanded'));
                });
            });
            
            // API Key 設定
            ui.saveApiKeyBtn.addEventListener('click', () => {
                const key = ui.apiKeyInput.value.trim();
                if (key) {
                    gameState.geminiApiKey = key;
                    showMessage("保存成功", "API Key 已保存！", () => {});
                    saveGame();
                } else {
                    showMessage("輸入無效", "API Key不能為空。", () => {});
                }
                updateUI();
            });
            
            // 個性預設按鈕
            ui.presetConservative.addEventListener('click', () => {
                ui.personaPrompt.value = presetPersonas['conservative'];
            });
            ui.presetActivist.addEventListener('click', () => {
                ui.personaPrompt.value = presetPersonas['activist'];
            });
            ui.presetPragmatic.addEventListener('click', () => {
                ui.personaPrompt.value = presetPersonas['pragmatic'];
            });
            
            ui.updatePersonaBtn.addEventListener('click', () => {
                const newPrompt = ui.personaPrompt.value.trim();
                if (newPrompt) {
                    gameState.aiPersonaPrompt = newPrompt;
                    saveGame();
                    showMessage("更新成功", "AI生態顧問個性已更新！", () => {});
                }
            });
            
            // 頭像設定
            ui.setScientistPortraitBtn.addEventListener('click', () => setPortrait(defaultPortraits.scientist));
            ui.setActivistPortraitBtn.addEventListener('click', () => setPortrait(defaultPortraits.activist));
            ui.setResearcherPortraitBtn.addEventListener('click', () => setPortrait(defaultPortraits.researcher));
            
            ui.setUrlPortraitBtn.addEventListener('click', () => {
                const url = ui.portraitUrlInput.value.trim();
                if (url) {
                    setPortrait(url);
                    ui.portraitUrlInput.value = '';
                } else {
                    showMessage("網址無效", "請輸入有效的圖片網址。", () => {});
                }
            });
            
            ui.uploadPortraitInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                if (!['image/jpeg', 'image/png'].includes(file.type)) {
                    showMessage("格式錯誤", "請上傳 .jpg 或 .png 格式的圖片。", () => {});
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (e.target.result.length > 1000 * 1024) {
                        showMessage("檔案過大", "圖片檔案太大(>700KB)，可能導致存檔失敗。", () => {});
                        return;
                    }
                    setPortrait(e.target.result);
                };
                reader.readAsDataURL(file);
            });
            
            // 遊戲控制
            ui.newEventBtn.addEventListener('click', generateNewEvent);
            ui.yesBtn.addEventListener('click', () => submitDecision('實施'));
            ui.noBtn.addEventListener('click', () => submitDecision('拒絕'));
            ui.submitDecisionBtn.addEventListener('click', () => submitDecision());
            
            ui.playerInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    ui.submitDecisionBtn.click();
                }
            });
            
            // 其他按鈕
            ui.newGameBtn.addEventListener('click', () => 
                showMessage("確認重新開始", "您確定要重新開始生態保護任務嗎？這會重置時間軸與生態指標，但會保留您的顧問設定。", startNewGame, true)
            );
            
            ui.saveGameBtn.addEventListener('click', () => {
                saveGame();
                showTempMessage("遊戲狀態已更新（注意：在此環境中無法永久保存）");
            });
            
            ui.loadGameBtn.addEventListener('click', () => {
                loadGame();
                showTempMessage("遊戲狀態已重新載入");
            });
            
            ui.openHelpBtn.addEventListener('click', showHelpModal);
            ui.closeHelpBtn.addEventListener('click', closeHelpModal);
            
            ui.helpModal.addEventListener('click', (event) => {
                if (event.target === ui.helpModal) {
                    closeHelpModal();
                }
            });
            
            ui.ecosystemTypeSelect.addEventListener('change', (e) => {
                gameState.ecosystemType = e.target.value;
                if (gameState.time > 0) saveGame();
                updateUI();
            });
            
            loadGame();
        }

        init();
    </script>
</body>
</html>